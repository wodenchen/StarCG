<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‚·å®³è¨ˆç®—æ©Ÿ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f5f7fa;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --accent-gold: #e67e22;
            --accent-silver: #7f8c8d;
            --accent-bronze: #a0522d;
            --accent-blue: #3498db;
            --accent-red: #e74c3c;
            --accent-green: #27ae60;
            --accent-purple: #9b59b6;
            --accent-orange: #f39c12;
            --accent-cyan: #1abc9c;
            --accent-pink: #e91e63;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --border-color: #dce4ec;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: var(--bg-primary);
            background-image: 
                radial-gradient(ellipse at top left, rgba(52, 152, 219, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at bottom right, rgba(230, 126, 34, 0.08) 0%, transparent 50%);
            min-height: 100vh;
            color: var(--text-primary);
            padding: 15px;
            font-size: 18px;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        h1 {
            text-align: center;
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            margin-bottom: 20px;
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .calculator-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--accent-gold);
            color: var(--accent-gold);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .input-group { margin-bottom: 12px; }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .input-group input[type="number"],
        .input-group select,
        .input-group input[type="text"] {
            width: 100%;
            padding: 12px 15px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15);
        }

        .skill-input-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 8px;
        }

        .skill-input-row input[type="range"] { 
            flex: 1; 
            margin: 0;
            height: 30px;
        }

        .skill-input-row input[type="number"] {
            width: 75px;
            padding: 10px 8px;
            text-align: center;
            background: var(--bg-secondary);
            border: 2px solid var(--accent-blue);
            border-radius: 8px;
            color: var(--accent-blue);
            font-size: 16px;
            font-weight: 700;
        }

        .skill-input-row .percent-sign {
            color: var(--accent-blue);
            font-weight: 700;
        }

        /* å¿«æ·æŒ‰éˆ•å€ */
        .quick-buttons-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed var(--border-color);
        }

        .quick-buttons-group {
            margin-bottom: 12px;
        }

        .quick-buttons-group:last-child {
            margin-bottom: 0;
        }

        .quick-buttons-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
            font-weight: 500;
        }

        .quick-buttons-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 8px;
        }

        .quick-buttons-row:last-child {
            margin-bottom: 0;
        }

        .quick-btn {
            flex: 1;
            min-width: 80px;
            padding: 8px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--accent-blue);
            border-radius: 6px;
            color: var(--accent-blue);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-btn:hover {
            background: var(--accent-blue);
            color: #fff;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
        }

        .quick-select {
            flex: 1;
            min-width: 150px;
            padding: 8px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--accent-blue);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15);
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        select option {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .toggle-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            padding: 8px 0;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 28px;
            flex-shrink: 0;
        }

        .toggle-switch input { opacity: 0; width: 0; height: 0; }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccd5de;
            border: 1px solid var(--border-color);
            transition: 0.3s;
            border-radius: 28px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 2px;
            bottom: 2px;
            background-color: #fff;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--accent-blue);
            border-color: var(--accent-blue);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(22px);
            background-color: #fff;
        }

        .toggle-label { color: var(--text-secondary); font-size: 0.95rem; }

        .btn-calculate {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--accent-gold), #ff8f00);
            border: none;
            border-radius: 8px;
            color: #000;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }

        .btn-calculate:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(249, 168, 37, 0.4);
        }

        .btn-add-compare {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--accent-purple), #7b1fa2);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }

        .btn-add-compare:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(171, 71, 188, 0.4);
        }

        .btn-clear-list {
            padding: 6px 14px;
            background: transparent;
            border: 1px solid var(--accent-red);
            border-radius: 5px;
            color: var(--accent-red);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-clear-list:hover {
            background: var(--accent-red);
            color: #fff;
        }

        /* çµæœå€åŸŸ */
        .results-section {
            grid-column: 1 / -1;
            margin-top: 15px;
        }

        .results-card {
            background: linear-gradient(135deg, #fff, #fef9f3);
            border: 2px solid var(--accent-gold);
        }

        /* åŸºç¤æ•¸å€¼å€ */
        .base-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dashed var(--border-color);
        }

        .base-result-item {
            background: #f8f9fa;
            padding: 12px 8px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .base-result-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .base-result-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent-blue);
        }

        .base-result-value.gold { color: var(--accent-gold); }
        .base-result-value.orange { color: var(--accent-orange); }

        /* ä¿®æ­£å€¼é¡¯ç¤º */
        .modifier-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dashed var(--border-color);
        }

        .modifier-item {
            background: #f8f9fa;
            padding: 10px 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            border: 1px solid var(--border-color);
        }

        .modifier-label { color: var(--text-secondary); font-size: 0.85rem; }
        .modifier-value { font-weight: 700; font-size: 0.95rem; }
        .modifier-positive { color: var(--accent-green); }
        .modifier-negative { color: var(--accent-red); }
        .modifier-neutral { color: var(--text-secondary); }

        /* æ”¹é€ å€ç‡è¡¨ */
        .reform-table-section {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dashed var(--border-color);
        }

        .reform-table-title {
            font-size: 0.9rem;
            color: var(--accent-orange);
            margin-bottom: 10px;
            font-weight: 600;
        }

        .reform-table {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 6px;
            font-size: 0.8rem;
        }

        .reform-table-cell {
            background: #f0f3f7;
            padding: 8px 4px;
            border-radius: 6px;
            text-align: center;
        }

        .reform-table-cell.header {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .reform-table-cell.active {
            background: var(--accent-orange);
            color: #000;
            font-weight: 700;
        }

        /* å‚·å®³çµæœå€ */
        .damage-results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }

        .damage-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 12px;
            border: 1px solid var(--border-color);
        }

        .damage-box-title {
            font-size: 0.95rem;
            font-weight: 700;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .damage-box.normal-atk { border-color: var(--accent-cyan); }
        .damage-box.normal-atk .damage-box-title { color: var(--accent-cyan); }
        .damage-box.no-crit .damage-box-title { color: var(--accent-silver); }
        .damage-box.with-crit .damage-box-title { color: var(--accent-orange); }
        .damage-box.with-boss .damage-box-title { color: var(--accent-red); }

        .damage-box.highlight {
            border-color: var(--accent-gold);
            background: linear-gradient(135deg, #fffbf5, #fff3e0);
        }
        .damage-box.highlight .damage-box-title { color: var(--accent-gold); }

        .tag {
            font-size: 0.65rem;
            padding: 2px 5px;
            border-radius: 4px;
            font-weight: 600;
        }

        .tag-normal { background: var(--accent-cyan); color: #fff; }
        .tag-skill { background: var(--accent-purple); color: #fff; }
        .tag-crit { background: var(--accent-orange); color: #fff; }
        .tag-no-crit { background: #bdc3c7; color: #555; }
        .tag-boss { background: var(--accent-red); color: #fff; }
        .tag-no-boss { background: #dce4ec; color: #777; }

        .damage-category {
            margin-bottom: 20px;
        }

        .damage-category:last-child {
            margin-bottom: 0;
        }

        .damage-category-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            padding: 8px 12px;
            background: #f0f3f7;
            border-radius: 6px;
            border-left: 4px solid var(--accent-blue);
        }

        .damage-category:last-child .damage-category-title {
            border-left-color: var(--accent-red);
        }

        .damage-values {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .damage-stat { text-align: center; }
        .damage-stat-label { font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 3px; }
        .damage-stat-value { font-size: 1.1rem; font-weight: 700; }
        .damage-stat.min .damage-stat-value { color: var(--accent-green); }
        .damage-stat.avg .damage-stat-value { color: var(--accent-blue); }
        .damage-stat.max .damage-stat-value { color: var(--accent-red); }

        /* æ”¹é€ ç­‰ç´šæ¨™ç±¤ */
        .reform-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
        }

        .reform-0 { background: #bdc3c7; color: #555; }
        .reform-1 { background: #2e7d32; color: #fff; }
        .reform-2 { background: #1976d2; color: #fff; }
        .reform-3 { background: #7b1fa2; color: #fff; }
        .reform-4 { background: #c62828; color: #fff; }
        .reform-5 { background: linear-gradient(135deg, #f9a825, #ff6f00); color: #000; }

        .skill-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            background: linear-gradient(135deg, #00bcd4, #0097a7);
            color: #fff;
            white-space: nowrap;
        }

        .grade-normal { color: var(--accent-bronze); }
        .grade-silver { color: var(--accent-silver); }
        .grade-gold { color: var(--accent-gold); }

        /* æ¯”è¼ƒæ¸…å–® */
        .compare-list-card {
            background: linear-gradient(135deg, #fff, #f8f5ff);
            border: 2px solid var(--accent-purple);
        }

        .compare-list-card .card-title {
            border-bottom-color: var(--accent-purple);
            color: var(--accent-purple);
        }

        .compare-list-empty {
            text-align: center;
            padding: 30px 15px;
            color: var(--text-secondary);
        }

        .compare-list-empty .icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .compare-list-scroll {
            max-height: 1280px;
            overflow-x: auto;
            overflow-y: auto;
        }

        .compare-list-scroll::-webkit-scrollbar { width: 8px; height: 8px; }
        .compare-list-scroll::-webkit-scrollbar-track { background: var(--bg-secondary); border-radius: 4px; }
        .compare-list-scroll::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        .compare-list-scroll::-webkit-scrollbar-thumb:hover { background: var(--accent-purple); }

        .compare-list-table {
            width: 100%;
            min-width: 1400px;
            border-collapse: collapse;
            font-size: 15px;
        }

        .compare-list-table th {
            background: #f0f3f7;
            padding: 12px 8px;
            text-align: center;
            color: var(--text-secondary);
            font-weight: 600;
            position: sticky;
            top: 0;
            white-space: nowrap;
            font-size: 15px;
            border: 1px solid var(--border-color);
        }

        .compare-list-table thead tr:first-child th {
            top: 0;
        }

        .compare-list-table thead tr:nth-child(2) th {
            top: 42px;
            background: #e8ecf0;
            font-size: 14px;
        }

        .compare-list-table th:first-child { text-align: left; padding-left: 12px; }

        .compare-list-table td {
            padding: 12px 8px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }

        .compare-list-table td:first-child { text-align: left; padding-left: 12px; }

        .compare-list-table tbody tr:hover { background: rgba(171, 71, 188, 0.1); }

        .compare-list-table .item-name {
            font-weight: 600;
            color: var(--accent-purple);
            max-width: 130px;
            word-break: break-all;
            white-space: normal;
            cursor: pointer;
            position: relative;
        }

        .compare-list-table .item-name:hover {
            background: rgba(171, 71, 188, 0.1);
            border-radius: 4px;
        }

        .compare-list-table .item-name input {
            width: 100%;
            padding: 4px 6px;
            border: 2px solid var(--accent-purple);
            border-radius: 4px;
            background: #fff;
            color: var(--text-primary);
            font-size: 15px;
            font-weight: 600;
            font-family: 'Noto Sans TC', sans-serif;
        }

        .compare-list-table .item-name input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(171, 71, 188, 0.2);
        }

        .compare-list-table tbody tr {
            cursor: move;
        }

        .compare-list-table tbody tr.dragging {
            opacity: 0.5;
            background: rgba(171, 71, 188, 0.2);
        }

        .compare-list-table tbody tr.drag-over {
            border-top: 3px solid var(--accent-purple);
        }

        .compare-list-table .dmg-cell {
            font-weight: 600;
            font-size: 15px;
        }

        .btn-delete-item {
            background: transparent;
            border: none;
            color: var(--accent-red);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 5px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .btn-delete-item:hover { opacity: 1; }

        .btn-move {
            background: transparent;
            border: 1px solid var(--accent-purple);
            color: var(--accent-purple);
            cursor: pointer;
            font-size: 14px;
            padding: 3px 8px;
            border-radius: 4px;
            transition: all 0.2s;
            margin-right: 3px;
        }

        .btn-move:hover {
            background: var(--accent-purple);
            color: #fff;
        }

        .btn-move:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .btn-move:disabled:hover {
            background: transparent;
            color: var(--accent-purple);
        }

        .btn-set-base {
            background: transparent;
            border: 1px solid var(--accent-cyan);
            color: var(--accent-cyan);
            cursor: pointer;
            font-size: 13px;
            padding: 5px 10px;
            border-radius: 4px;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-set-base:hover {
            background: var(--accent-cyan);
            color: #000;
        }

        .btn-set-base.active {
            background: var(--accent-gold);
            border-color: var(--accent-gold);
            color: #000;
            font-weight: 600;
        }

        .base-row {
            background: rgba(230, 126, 34, 0.12) !important;
        }

        .base-row td:first-child::before {
            content: 'â­';
            font-size: 14px;
        }

        .base-indicator {
            display: inline-block;
            background: var(--accent-gold);
            color: #000;
            font-size: 12px;
            padding: 3px 6px;
            border-radius: 4px;
            margin-left: 6px;
            font-weight: 600;
        }

        .highlight-row { animation: highlightFade 2s ease-out; }

        @keyframes highlightFade {
            0% { background: rgba(155, 89, 182, 0.2); }
            100% { background: transparent; }
        }

        .list-diff-positive { color: var(--accent-green); font-weight: 600; font-size: 13px; }
        .list-diff-negative { color: var(--accent-red); font-weight: 600; font-size: 13px; }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
        }

        .status-yes { background: var(--accent-green); color: #fff; }
        .status-no { background: #bdc3c7; color: #555; }

        /* æ‰‹æ©Ÿç‰ˆå„ªåŒ– */
        @media (max-width: 600px) {
            body { padding: 10px; }
            
            .calculator-grid { 
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .card { padding: 12px; }
            
            .input-row { grid-template-columns: 1fr; gap: 10px; }
            
            .damage-results-grid { grid-template-columns: 1fr; gap: 12px; }
            
            .base-results { grid-template-columns: repeat(2, 1fr); }
            
            .modifier-section { grid-template-columns: 1fr 1fr; }
            
            .reform-table { 
                grid-template-columns: repeat(3, 1fr); 
                font-size: 0.75rem;
            }
            
            .damage-stat-value { font-size: 1rem; }
            
            .compare-list-table { font-size: 0.9rem; min-width: 800px; }
            .compare-list-table th { padding: 10px 6px; font-size: 0.85rem; }
            .compare-list-table td { padding: 10px 6px; }
            .compare-list-table .dmg-cell { font-size: 0.95rem; }
        }

        @media (max-width: 400px) {
            h1 { font-size: 1.3rem; margin-bottom: 15px; }
            .card-title { font-size: 1rem; }
            .base-result-value { font-size: 1rem; }
            .modifier-section { grid-template-columns: 1fr; }
        }

        /* å…¬å¼èªªæ˜å€ */
        .formula-toggle {
            background: transparent;
            border: 1px solid var(--accent-cyan);
            color: var(--accent-cyan);
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .formula-toggle:hover {
            background: var(--accent-cyan);
            color: #000;
        }

        .formula-section {
            display: none;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            font-size: 0.85rem;
            line-height: 1.8;
        }

        .formula-section.show {
            display: block;
        }

        .formula-section h4 {
            color: var(--accent-cyan);
            margin-bottom: 12px;
            font-size: 0.95rem;
        }

        .formula-item {
            background: #fff;
            padding: 10px 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 3px solid var(--accent-blue);
            border: 1px solid var(--border-color);
            border-left: 3px solid var(--accent-blue);
        }

        .formula-item:last-child {
            margin-bottom: 0;
        }

        .formula-item.main {
            border-left-color: var(--accent-gold);
            background: linear-gradient(90deg, rgba(230, 126, 34, 0.1), #fff);
        }

        .formula-label {
            color: var(--accent-blue);
            font-weight: 600;
            display: block;
            margin-bottom: 5px;
        }

        .formula-item.main .formula-label {
            color: var(--accent-gold);
        }

        .formula-code {
            font-family: 'Consolas', 'Monaco', monospace;
            color: var(--text-primary);
            word-break: break-all;
        }

        .formula-note {
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-top: 5px;
            font-style: italic;
        }

        .formula-var {
            color: var(--accent-green);
        }

        .formula-op {
            color: var(--accent-orange);
        }

        .formula-table-toggle {
            background: transparent;
            border: 1px solid var(--accent-blue);
            color: var(--accent-blue);
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 5px;
            display: inline-block;
        }

        .formula-table-toggle:hover {
            background: var(--accent-blue);
            color: #fff;
        }

        .formula-table {
            display: none;
            margin-top: 10px;
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }

        .formula-table.show {
            display: block;
        }

        .formula-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
            background: #fff;
            border-radius: 6px;
            overflow: hidden;
        }

        .formula-table th {
            background: var(--accent-blue);
            color: #fff;
            padding: 8px 6px;
            text-align: center;
            font-weight: 600;
            border: 1px solid var(--accent-blue);
        }

        .formula-table td {
            padding: 6px 4px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .formula-table tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        .formula-table tbody tr:hover {
            background: rgba(52, 152, 219, 0.1);
        }

        @media (max-width: 600px) {
            .formula-section { font-size: 0.8rem; padding: 12px; }
            .formula-item { padding: 8px 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>âš”ï¸ å‚·å®³è¨ˆç®—æ©Ÿ âš”ï¸</h1>
        
        <div class="calculator-grid">
            <!-- åŸºæœ¬æ•¸å€¼ -->
            <div class="card">
                <div class="card-title">ğŸ“Š åŸºæœ¬æ•¸å€¼</div>
                <div class="input-row">
                    <div class="input-group">
                        <label>æ”»æ“ŠåŠ›</label>
                        <input type="number" id="attack" value="500" min="0" inputmode="numeric">
                    </div>
                    <div class="input-group">
                        <label>é˜²ç¦¦åŠ› (è¢«æ‰“æ–¹)</label>
                        <input type="number" id="defense" value="300" min="0" inputmode="numeric">
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label>æ”»æ“Šæ–¹ç­‰ç´š</label>
                        <input type="number" id="attackerLevel" value="100" min="1" inputmode="numeric">
                    </div>
                    <div class="input-group">
                        <label>é˜²ç¦¦æ–¹ç­‰ç´š</label>
                        <input type="number" id="defenderLevel" value="100" min="1" inputmode="numeric">
                    </div>
                </div>
            </div>

            <!-- æ­¦å™¨èˆ‡å±¬æ€§ -->
            <div class="card">
                <div class="card-title">ğŸ—¡ï¸ æ­¦å™¨èˆ‡å±¬æ€§</div>
                <div class="input-group">
                    <label>æ­¦å™¨éŠ³åˆ©åº¦</label>
                    <select id="weaponSharpness">
                        <option value="0">ç©ºæ‰‹ (+0%)</option>
                        <option value="0.15" selected>æœ‰æ­¦å™¨ (+15%)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>æ°´æ™¶å±¬æ€§å½±éŸ¿</label>
                    <select id="crystalElement">
                        <option value="0.30" data-label="å…¨å‰‹">å…¨å‰‹ (+30%)</option>
                        <option value="0.15" data-label="åŠå‰‹">åŠå‰‹ (+15%)</option>
                        <option value="0.06" data-label="é˜²å®ˆæ–¹å…¨å±¬æ€§2">é˜²å®ˆæ–¹å…¨å±¬æ€§2 (+6%)</option>
                        <option value="0" data-label="ä¸ç›¸å‰‹" selected>ä¸ç›¸å‰‹ (+0%)</option>
                        <option value="-0.06" data-label="é˜²å®ˆæ–¹å…¨å±¬æ€§3">é˜²å®ˆæ–¹å…¨å±¬æ€§3 (-6%)</option>
                        <option value="-0.15" data-label="è¢«åŠå‰‹">è¢«åŠå‰‹ (-15%)</option>
                        <option value="-0.18" data-label="é˜²å®ˆæ–¹å…¨å±¬æ€§4">é˜²å®ˆæ–¹å…¨å±¬æ€§4 (-18%)</option>
                        <option value="-0.30" data-label="è¢«å…¨å‰‹">è¢«å…¨å‰‹ (-30%)</option>
                        <option value="-0.30" data-label="é˜²å®ˆæ–¹å…¨å±¬æ€§5">é˜²å®ˆæ–¹å…¨å±¬æ€§5 (-30%)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>ç¨®æ—å½±éŸ¿</label>
                    <select id="raceEffect">
                        <option value="0.20" data-label="å…¨å‰‹">å…¨å‰‹ (+20%)</option>
                        <option value="0.10" data-label="åŠå‰‹">åŠå‰‹ (+10%)</option>
                        <option value="0" data-label="ä¸ç›¸å‰‹" selected>ä¸ç›¸å‰‹ (+0%)</option>
                        <option value="-0.10" data-label="è¢«åŠå‰‹">è¢«åŠå‰‹ (-10%)</option>
                        <option value="-0.20" data-label="è¢«å…¨å‰‹">è¢«å…¨å‰‹ (-20%)</option>
                    </select>
                </div>
            </div>

            <!-- æŠ€èƒ½å€ç‡ -->
            <div class="card">
                <div class="card-title">âœ¨ æŠ€èƒ½å‚·å®³å€ç‡</div>
                <div class="input-group">
                    <label>æŠ€èƒ½å€ç‡ (20% ~ 220%)</label>
                    <div class="skill-input-row">
                        <input type="range" id="skillMultiplierRange" min="20" max="220" value="100">
                        <input type="number" id="skillMultiplierInput" min="20" max="220" value="100" inputmode="numeric">
                        <span class="percent-sign">%</span>
                    </div>
                </div>
                
                <!-- å¿«æ·æŒ‰éˆ•å€ -->
                <div class="quick-buttons-section">
                    <div class="quick-buttons-group">
                        <div class="quick-buttons-label">å¯µç‰©ä¹¾å¤</div>
                        <div class="quick-buttons-row">
                            <button class="quick-btn" onclick="setSkillMultiplier(150)">III (150%)</button>
                            <button class="quick-btn" onclick="setSkillMultiplier(170)">IV (170%)</button>
                            <button class="quick-btn" onclick="setSkillMultiplier(190)">V (190%)</button>
                        </div>
                        <div class="quick-buttons-row">
                            <button class="quick-btn" onclick="setSkillMultiplier(200)">â—† (200%)</button>
                            <button class="quick-btn" onclick="setSkillMultiplier(210)">â—†â—† (210%)</button>
                            <button class="quick-btn" onclick="setSkillMultiplier(220)">â—†â—†â—† (220%)</button>
                        </div>
                    </div>
                    
                    <div class="quick-buttons-group">
                        <div class="quick-buttons-label">ç‰¹æ®ŠæŠ€èƒ½</div>
                        <div class="quick-buttons-row">
                            <button class="quick-btn" onclick="setSkillMultiplier(210)">æ­Œå§¬/æ»…é¾ (210%)</button>
                        </div>
                    </div>
                    
                    <div class="quick-buttons-group">
                        <div class="quick-buttons-label">äººç‰©äº‚å°„ï¼ˆé¦–3ç®­ï¼‰</div>
                        <div class="quick-buttons-row">
                            <button class="quick-btn" onclick="setSkillMultiplier(50)">ç¬¬1ç®­ (50%)</button>
                            <button class="quick-btn" onclick="setSkillMultiplier(35)">ç¬¬2ç®­ (35%)</button>
                            <button class="quick-btn" onclick="setSkillMultiplier(20)">ç¬¬3ç®­ (20%)</button>
                        </div>
                    </div>
                    
                    <div class="quick-buttons-group">
                        <div class="quick-buttons-label">äººç‰©ä¹¾å¤</div>
                        <div class="quick-buttons-row">
                            <select id="qiankunLevel" class="quick-select" onchange="setQiankunMultiplier()">
                                <option value="">é¸æ“‡ç­‰ç´š</option>
                                <option value="1">1ç­‰ (110%)</option>
                                <option value="2">2ç­‰ (120%)</option>
                                <option value="3">3ç­‰ (130%)</option>
                                <option value="4">4ç­‰ (140%)</option>
                                <option value="5">5ç­‰ (150%)</option>
                                <option value="6">6ç­‰ (160%)</option>
                                <option value="7">7ç­‰ (170%)</option>
                                <option value="8">8ç­‰ (180%)</option>
                                <option value="9">9ç­‰ (190%)</option>
                                <option value="10">10ç­‰ (200%)</option>
                                <option value="11">11ç­‰ (210%)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="quick-buttons-group">
                        <div class="quick-buttons-label">äººç‰©è¿´æ—‹</div>
                        <div class="quick-buttons-row">
                            <select id="huixuanLevel" class="quick-select" onchange="setHuixuanMultiplier()">
                                <option value="">é¸æ“‡ç­‰ç´š</option>
                                <option value="1-1">1ç­‰ ä½ (56%)</option>
                                <option value="1-2">1ç­‰ ä¸­ (70%)</option>
                                <option value="1-3">1ç­‰ é«˜ (84%)</option>
                                <option value="2-1">2ç­‰ ä½ (60%)</option>
                                <option value="2-2">2ç­‰ ä¸­ (75%)</option>
                                <option value="2-3">2ç­‰ é«˜ (90%)</option>
                                <option value="3-1">3ç­‰ ä½ (64%)</option>
                                <option value="3-2">3ç­‰ ä¸­ (80%)</option>
                                <option value="3-3">3ç­‰ é«˜ (96%)</option>
                                <option value="4-1">4ç­‰ ä½ (68%)</option>
                                <option value="4-2">4ç­‰ ä¸­ (85%)</option>
                                <option value="4-3">4ç­‰ é«˜ (102%)</option>
                                <option value="5-1">5ç­‰ ä½ (72%)</option>
                                <option value="5-2">5ç­‰ ä¸­ (90%)</option>
                                <option value="5-3">5ç­‰ é«˜ (108%)</option>
                                <option value="6-1">6ç­‰ ä½ (76%)</option>
                                <option value="6-2">6ç­‰ ä¸­ (95%)</option>
                                <option value="6-3">6ç­‰ é«˜ (114%)</option>
                                <option value="7-1">7ç­‰ ä½ (80%)</option>
                                <option value="7-2">7ç­‰ ä¸­ (100%)</option>
                                <option value="7-3">7ç­‰ é«˜ (120%)</option>
                                <option value="8-1">8ç­‰ ä½ (84%)</option>
                                <option value="8-2">8ç­‰ ä¸­ (105%)</option>
                                <option value="8-3">8ç­‰ é«˜ (126%)</option>
                                <option value="9-1">9ç­‰ ä½ (88%)</option>
                                <option value="9-2">9ç­‰ ä¸­ (110%)</option>
                                <option value="9-3">9ç­‰ é«˜ (132%)</option>
                                <option value="10-1">10ç­‰ ä½ (92%)</option>
                                <option value="10-2">10ç­‰ ä¸­ (115%)</option>
                                <option value="10-3">10ç­‰ é«˜ (138%)</option>
                                <option value="11-1">11ç­‰ ä½ (96%)</option>
                                <option value="11-2">11ç­‰ ä¸­ (120%)</option>
                                <option value="11-3">11ç­‰ é«˜ (144%)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="quick-buttons-group">
                        <div class="quick-buttons-label">äººç‰©è¿½æœˆ</div>
                        <div class="quick-buttons-row">
                            <select id="zhuiyueLevel" class="quick-select" onchange="setZhuiyueMultiplier()">
                                <option value="">é¸æ“‡ç­‰ç´š</option>
                                <option value="1">1ç­‰ Iå‹ (70%)</option>
                                <option value="2">2ç­‰ Iå‹ (75%)</option>
                                <option value="3">3ç­‰ Iå‹ (80%)</option>
                                <option value="4">4ç­‰ Iå‹ (85%)</option>
                                <option value="5">5ç­‰ Tå‹ (75%)</option>
                                <option value="6">6ç­‰ Tå‹ (78%)</option>
                                <option value="7">7ç­‰ Tå‹ (81%)</option>
                                <option value="8">8ç­‰ Tå‹ (85%)</option>
                                <option value="9">9ç­‰ IIIå‹ (75%)</option>
                                <option value="10">10ç­‰ IIIå‹ (80%)</option>
                                <option value="11">11ç­‰ IIIå‹ (95%)</option>
                            </select>
                            <label class="toggle-switch" style="margin-left: 10px;">
                                <input type="checkbox" id="zhuiyuePVE" onchange="setZhuiyueMultiplier()">
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="toggle-label" style="font-size: 0.85rem;">PVEå¢å‚·</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¯µç‰©åŠ ä¹˜ -->
            <div class="card">
                <div class="card-title">ğŸ¾ å¯µç‰©åŠ ä¹˜è¨­å®š</div>

                <div class="input-group">
                    <label>å¯µç‰©å¡ç‰‡ç­‰ç´š</label>
                    <select id="petGrade">
                        <option value="normal">æ™®å¡å¯µ</option>
                        <option value="silver">éŠ€å¡å¯µ</option>
                        <option value="gold" selected>é‡‘å¡å¯µ</option>
                    </select>
                </div>

                <div class="toggle-group">
                    <label class="toggle-switch">
                        <input type="checkbox" id="maxStats" checked>
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="toggle-label">æ»¿æª”ç‹€æ…‹</span>
                </div>

                <div class="toggle-group">
                    <label class="toggle-switch">
                        <input type="checkbox" id="beastPassive">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="toggle-label">é‡ç¸ç³»è¢«å‹•</span>
                </div>

                <div class="input-group">
                    <label>å¯µç‰©æ”¹é€ ç­‰ç´š (BOSSæˆ°ç”¨)</label>
                    <select id="petReform">
                        <option value="0">æœªæ”¹é€ </option>
                        <option value="1">ä¸€æ”¹</option>
                        <option value="2">äºŒæ”¹</option>
                        <option value="3">ä¸‰æ”¹</option>
                        <option value="4">å››æ”¹</option>
                        <option value="5">äº”æ”¹</option>
                    </select>
                </div>
            </div>

            <!-- é­”æ³•å‚·å®³è¨ˆç®— -->
            <div class="card">
                <div class="card-title">ğŸ”® é­”æ³•å‚·å®³è¨ˆç®—</div>
                
                <div class="input-group">
                    <label>æ–½æ³•è€…é¡å‹</label>
                    <select id="magicCasterType" onchange="updateMagicOptions()">
                        <option value="character">äººç‰©</option>
                        <option value="pet">å¯µç‰©</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label>é­”æ³•é¡å‹</label>
                    <select id="magicType" onchange="updateMagicLevelOptions()">
                        <option value="single">å–®é«”é­”æ³•</option>
                        <option value="strong">å¼·åŠ›é­”æ³•</option>
                        <option value="super" id="magicTypeSuper">è¶…å¼·é­”æ³•</option>
                        <option value="drain" id="magicTypeDrain">å¸è¡€é­”æ³•</option>
                    </select>
                </div>
                
                <div class="input-row">
                    <div class="input-group">
                        <label>é­”æ³•ç­‰ç´š</label>
                        <select id="magicLevel">
                            <option value="1">1ç­‰</option>
                            <option value="2">2ç­‰</option>
                            <option value="3">3ç­‰</option>
                            <option value="4">4ç­‰</option>
                            <option value="5">5ç­‰</option>
                            <option value="6">6ç­‰</option>
                            <option value="7">7ç­‰</option>
                            <option value="8">8ç­‰</option>
                            <option value="9">9ç­‰</option>
                            <option value="10">10ç­‰</option>
                            <option value="11" id="magicLevel11">11ç­‰</option>
                            <option value="ex" id="magicLevelEx" style="display: none;">EX</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>æ–½æ³•è€…ç²¾ç¥</label>
                        <input type="number" id="magicCasterSpirit" value="300" min="0" inputmode="numeric">
                    </div>
                </div>
                
                <div class="input-row">
                    <div class="input-group">
                        <label>å—æ³•è€…ç²¾ç¥</label>
                        <input type="number" id="magicTargetSpirit" value="200" min="0" inputmode="numeric">
                    </div>
                    <div class="input-group">
                        <label>é­”æ”» (åƒ…äººç‰©)</label>
                        <input type="number" id="magicAttack" value="0" min="0" inputmode="numeric">
                    </div>
                </div>
                
                <div class="toggle-group" id="magicPVEGroup" style="display: none;">
                    <label class="toggle-switch">
                        <input type="checkbox" id="magicPVE">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="toggle-label">PVEå¢å‚· (+20%)</span>
                </div>
                
                <!-- å¯µç‰©ç›¸é—œé¸é … -->
                <div id="magicPetOptions" style="display: none;">
                    <div class="input-group">
                        <label>å¯µç‰©å¡åˆ¥</label>
                        <select id="magicPetGrade">
                            <option value="normal">æ™®å¡å¯µ</option>
                            <option value="silver">éŠ€å¡å¯µ</option>
                            <option value="gold" selected>é‡‘å¡å¯µ</option>
                        </select>
                    </div>
                    
                    <div class="toggle-group">
                        <label class="toggle-switch">
                            <input type="checkbox" id="magicMaxStats" checked>
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label">æ»¿æª”ç‹€æ…‹</span>
                    </div>
                    
                    <div class="toggle-group">
                        <label class="toggle-switch">
                            <input type="checkbox" id="magicBeastPassive">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label">é‡ç¸ç³»è¢«å‹•</span>
                    </div>
                    
                    <div class="input-group">
                        <label>å¯µç‰©æ”¹é€ ç­‰ç´š (BOSSæˆ°ç”¨)</label>
                        <select id="magicPetReform">
                            <option value="0">æœªæ”¹é€ </option>
                            <option value="1">ä¸€æ”¹</option>
                            <option value="2">äºŒæ”¹</option>
                            <option value="3">ä¸‰æ”¹</option>
                            <option value="4">å››æ”¹</option>
                            <option value="5">äº”æ”¹</option>
                        </select>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>æ°´æ™¶å±¬æ€§å½±éŸ¿</label>
                    <select id="magicCrystalElement">
                        <option value="0.30" data-label="å…¨å‰‹">å…¨å‰‹ (+30%)</option>
                        <option value="0.15" data-label="åŠå‰‹">åŠå‰‹ (+15%)</option>
                        <option value="0.06" data-label="é˜²å®ˆæ–¹å…¨å±¬æ€§2">é˜²å®ˆæ–¹å…¨å±¬æ€§2 (+6%)</option>
                        <option value="0" data-label="ä¸ç›¸å‰‹" selected>ä¸ç›¸å‰‹ (+0%)</option>
                        <option value="-0.06" data-label="é˜²å®ˆæ–¹å…¨å±¬æ€§3">é˜²å®ˆæ–¹å…¨å±¬æ€§3 (-6%)</option>
                        <option value="-0.15" data-label="è¢«åŠå‰‹">è¢«åŠå‰‹ (-15%)</option>
                        <option value="-0.18" data-label="é˜²å®ˆæ–¹å…¨å±¬æ€§4">é˜²å®ˆæ–¹å…¨å±¬æ€§4 (-18%)</option>
                        <option value="-0.30" data-label="è¢«å…¨å‰‹">è¢«å…¨å‰‹ (-30%)</option>
                        <option value="-0.30" data-label="é˜²å®ˆæ–¹å…¨å±¬æ€§5">é˜²å®ˆæ–¹å…¨å±¬æ€§5 (-30%)</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label>ç¨®æ—å½±éŸ¿</label>
                    <select id="magicRaceEffect">
                        <option value="0.20" data-label="å…¨å‰‹">å…¨å‰‹ (+20%)</option>
                        <option value="0.10" data-label="åŠå‰‹">åŠå‰‹ (+10%)</option>
                        <option value="0" data-label="ä¸ç›¸å‰‹" selected>ä¸ç›¸å‰‹ (+0%)</option>
                        <option value="-0.10" data-label="è¢«åŠå‰‹">è¢«åŠå‰‹ (-10%)</option>
                        <option value="-0.20" data-label="è¢«å…¨å‰‹">è¢«å…¨å‰‹ (-20%)</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label>é˜²å®ˆæ–¹æ´æ‚‰æŠ€èƒ½ç­‰ç´š</label>
                    <select id="magicInsightLevel">
                        <option value="0" selected>ç„¡</option>
                        <option value="1">1ç­‰ (-1%)</option>
                        <option value="2">2ç­‰ (-2%)</option>
                        <option value="3">3ç­‰ (-3%)</option>
                        <option value="4">4ç­‰ (-4%)</option>
                        <option value="5">5ç­‰ (-5%)</option>
                        <option value="6">6ç­‰ (-6%)</option>
                        <option value="7">7ç­‰ (-7%)</option>
                        <option value="8">8ç­‰ (-8%)</option>
                        <option value="9">9ç­‰ (-9%)</option>
                        <option value="10">10ç­‰ (-10%)</option>
                        <option value="11">11ç­‰ (-11%)</option>
                    </select>
                </div>
                
                <button class="btn-calculate" onclick="calculateMagic()" style="margin-top: 10px;">ğŸ”® è¨ˆç®—é­”æ³•å‚·å®³</button>
            </div>

            <!-- è¨ˆç®—æŒ‰éˆ• -->
            <div class="card" style="display: flex; flex-direction: column; justify-content: center;">
                <div class="input-group">
                    <label>è¨˜éŒ„åç¨± (åŠ å…¥æ¸…å–®ç”¨)</label>
                    <input type="text" id="recordName" placeholder="ä¾‹å¦‚ï¼šé‡‘å¯µäº”æ”¹æ»¿æª”">
                </div>
                <button class="btn-calculate" onclick="calculate()">ğŸ”¥ è¨ˆç®—å‚·å®³ ğŸ”¥</button>
                <button class="btn-add-compare" onclick="addToCompareList()">ğŸ“‹ åŠ å…¥æ¯”è¼ƒæ¸…å–®</button>
            </div>

            <!-- çµæœé¡¯ç¤º -->
            <div class="results-section">
                <div class="card results-card">
                    <div class="card-title">
                        <span>ğŸ“ˆ è¨ˆç®—çµæœ</span>
                        <button class="formula-toggle" onclick="toggleFormula()">ğŸ“ æŸ¥çœ‹å…¬å¼</button>
                    </div>

                    <!-- å…¬å¼èªªæ˜å€ -->
                    <div class="formula-section" id="formulaSection">
                        <h4>ğŸ“ å‚·å®³è¨ˆç®—å…¬å¼èªªæ˜</h4>
                        
                        <div class="formula-item">
                            <span class="formula-label">â‘  æ”»æ“Šå¯¦éš›æ•ˆæ‡‰å€¼</span>
                            <span class="formula-code">
                                <span class="formula-var">æ”»æ“Šæ•ˆæ‡‰</span> <span class="formula-op">=</span> <span class="formula-var">æ”»æ“ŠåŠ›</span>ï¼ˆè‹¥ â‰¤ 240ï¼‰<span class="formula-op">æˆ–</span> 240 <span class="formula-op">+</span> 0.3 <span class="formula-op">Ã—</span> (<span class="formula-var">æ”»æ“ŠåŠ›</span> <span class="formula-op">-</span> 240)ï¼ˆè‹¥ > 240ï¼‰
                            </span>
                        </div>

                        <div class="formula-item">
                            <span class="formula-label">â‘¡ é˜²ç¦¦å¯¦éš›æ•ˆæ‡‰å€¼</span>
                            <span class="formula-code">
                                <span class="formula-var">é˜²ç¦¦æ•ˆæ‡‰</span> <span class="formula-op">=</span> <span class="formula-var">é˜²ç¦¦åŠ›</span>ï¼ˆè‹¥ â‰¤ 240ï¼‰<span class="formula-op">æˆ–</span> 240 <span class="formula-op">+</span> 0.3 <span class="formula-op">Ã—</span> (<span class="formula-var">é˜²ç¦¦åŠ›</span> <span class="formula-op">-</span> 240)ï¼ˆè‹¥ > 240ï¼‰
                            </span>
                        </div>

                        <div class="formula-item">
                            <span class="formula-label">â‘¢ åŸºæœ¬å‚·å®³å€¼</span>
                            <span class="formula-code">
                                <span class="formula-var">åŸºæœ¬å‚·å®³</span> <span class="formula-op">=</span> <span class="formula-var">æ”»æ“Šæ•ˆæ‡‰</span>Â² <span class="formula-op">Ã—</span> 3 <span class="formula-op">Ã·</span> (<span class="formula-var">æ”»æ“Šæ•ˆæ‡‰</span> <span class="formula-op">+</span> <span class="formula-var">é˜²ç¦¦æ•ˆæ‡‰</span> <span class="formula-op">Ã—</span> 3)
                            </span>
                        </div>

                        <div class="formula-item">
                            <span class="formula-label">â‘£ å¿…æ®ºä¿®æ­£å€¼</span>
                            <span class="formula-code">
                                <span class="formula-var">å¿…æ®ºä¿®æ­£</span> <span class="formula-op">=</span> <span class="formula-var">è¢«æ‰“é˜²ç¦¦åŠ›</span> <span class="formula-op">Ã—</span> <span class="formula-var">æ”»æ“Šæ–¹ç­‰ç´š</span> <span class="formula-op">Ã·</span> (<span class="formula-var">é˜²ç¦¦æ–¹ç­‰ç´š</span> <span class="formula-op">Ã—</span> 2)
                            </span>
                            <div class="formula-note">â€» ç„¡å¿…æ®ºæ™‚æ­¤å€¼ç‚º 0</div>
                        </div>

                        <div class="formula-item main">
                            <span class="formula-label">â‘¤ å¯¦éš›å‚·å®³å€¼ï¼ˆå®Œæ•´å…¬å¼ï¼‰</span>
                            <span class="formula-code">
                                <span class="formula-var">å¯¦éš›å‚·å®³</span> <span class="formula-op">=</span> [<span class="formula-var">åŸºæœ¬å‚·å®³</span> <span class="formula-op">Ã—</span> <span class="formula-var">æ­¦å™¨ä¿®æ­£</span> <span class="formula-op">Ã—</span> <span class="formula-var">æ°´æ™¶å±¬æ€§</span> <span class="formula-op">Ã—</span> <span class="formula-var">éš¨æ©Ÿå€¼(90%~110%)</span> <span class="formula-op">+</span> <span class="formula-var">å¿…æ®ºä¿®æ­£</span>] <span class="formula-op">Ã—</span> <span class="formula-var">ç¨®æ—å½±éŸ¿</span> <span class="formula-op">Ã—</span> <span class="formula-var">æŠ€èƒ½å€ç‡</span> <span class="formula-op">Ã—</span> <span class="formula-var">æ»¿æª”åŠ ä¹˜</span> <span class="formula-op">Ã—</span> <span class="formula-var">æ”¹é€ BOSSå¢å‚·</span> <span class="formula-op">Ã—</span> <span class="formula-var">é‡ç¸è¢«å‹•</span>
                            </span>
                            <div class="formula-note">
                                â€» æ­¦å™¨ä¿®æ­£ï¼šç©ºæ‰‹=1.0ï¼Œæœ‰æ­¦å™¨=1.15<br>
                                â€» æ°´æ™¶å±¬æ€§ï¼šå…¨å‰‹=1.3ï¼ŒåŠå‰‹=1.15ï¼Œä¸ç›¸å‰‹=1.0ï¼Œè¢«åŠå‰‹=0.85ï¼Œè¢«å…¨å‰‹=0.7<br>
                                â€» ç¨®æ—å½±éŸ¿ï¼šå…¨å‰‹=1.2ï¼ŒåŠå‰‹=1.1ï¼Œä¸ç›¸å‰‹=1.0ï¼Œè¢«åŠå‰‹=0.9ï¼Œè¢«å…¨å‰‹=0.8<br>
                                â€» æ”¹é€ BOSSå¢å‚·ï¼šåƒ…åœ¨BOSSæˆ°æ™‚ç”Ÿæ•ˆ
                            </div>
                        </div>
                    </div>
                    
                    <!-- åŸºç¤è¨ˆç®—æ•¸å€¼ -->
                    <div class="base-results">
                        <div class="base-result-item">
                            <div class="base-result-label">æ”»æ“Šå¯¦éš›æ•ˆæ‡‰å€¼</div>
                            <div class="base-result-value" id="resultAttackEffect">-</div>
                        </div>
                        <div class="base-result-item">
                            <div class="base-result-label">é˜²ç¦¦å¯¦éš›æ•ˆæ‡‰å€¼</div>
                            <div class="base-result-value" id="resultDefenseEffect">-</div>
                        </div>
                        <div class="base-result-item">
                            <div class="base-result-label">åŸºæœ¬å‚·å®³å€¼</div>
                            <div class="base-result-value gold" id="resultBaseDamage">-</div>
                        </div>
                        <div class="base-result-item">
                            <div class="base-result-label">å¿…æ®ºä¿®æ­£å€¼</div>
                            <div class="base-result-value orange" id="resultCritCorrection">-</div>
                        </div>
                    </div>

                    <!-- å„é …ä¿®æ­£å€¼ -->
                    <div class="modifier-section">
                        <div class="modifier-item">
                            <span class="modifier-label">ğŸ’ æ°´æ™¶å±¬æ€§</span>
                            <span class="modifier-value" id="modCrystal">-</span>
                        </div>
                        <div class="modifier-item">
                            <span class="modifier-label">ğŸ‘¾ ç¨®æ—å½±éŸ¿</span>
                            <span class="modifier-value" id="modRace">-</span>
                        </div>
                        <div class="modifier-item">
                            <span class="modifier-label">âš”ï¸ æ­¦å™¨éŠ³åˆ©åº¦</span>
                            <span class="modifier-value" id="modWeapon">-</span>
                        </div>
                        <div class="modifier-item">
                            <span class="modifier-label">âœ¨ æŠ€èƒ½å€ç‡</span>
                            <span class="modifier-value" id="modSkill">-</span>
                        </div>
                        <div class="modifier-item">
                            <span class="modifier-label">ğŸ“Š æ»¿æª”åŠ ä¹˜</span>
                            <span class="modifier-value" id="modMaxStats">-</span>
                        </div>
                        <div class="modifier-item">
                            <span class="modifier-label">ğŸº é‡ç¸è¢«å‹•</span>
                            <span class="modifier-value" id="modBeast">-</span>
                        </div>
                    </div>

                    <!-- æ”¹é€ å€ç‡è¡¨ -->
                    <div class="reform-table-section">
                        <div class="reform-table-title">ğŸ”§ æ”¹é€ BOSSå¢å‚·å€ç‡ (ç•¶å‰å¡åˆ¥: <span id="currentGrade">é‡‘å¡</span>)</div>
                        <div class="reform-table" id="reformTable">
                            <!-- å‹•æ…‹ç”Ÿæˆ -->
                        </div>
                    </div>

                    <!-- å‚·å®³çµæœåˆ†é¡ -->
                    <div class="damage-category">
                        <h4 class="damage-category-title">ğŸ—¡ï¸ ä¸€èˆ¬å‚·å®³ï¼ˆç„¡BOSSå¢å‚·ï¼‰</h4>
                        <div class="damage-results-grid">
                            <!-- æ™®æ”»å‚·å®³ (100%, ç„¡å¿…æ®º) -->
                            <div class="damage-box normal-atk">
                                <div class="damage-box-title">
                                    <span class="tag tag-normal">æ™®æ”»100%</span>
                                    <span class="tag tag-no-crit">ç„¡å¿…æ®º</span>
                                </div>
                                <div class="damage-values">
                                    <div class="damage-stat min">
                                        <div class="damage-stat-label">æœ€å°</div>
                                        <div class="damage-stat-value" id="dmgNA_NoCrit_Min">-</div>
                                    </div>
                                    <div class="damage-stat avg">
                                        <div class="damage-stat-label">å¹³å‡</div>
                                        <div class="damage-stat-value" id="dmgNA_NoCrit_Avg">-</div>
                                    </div>
                                    <div class="damage-stat max">
                                        <div class="damage-stat-label">æœ€å¤§</div>
                                        <div class="damage-stat-value" id="dmgNA_NoCrit_Max">-</div>
                                    </div>
                                </div>
                            </div>

                            <!-- æŠ€èƒ½å‚·å®³ (æŠ€èƒ½%, ç„¡å¿…æ®º) -->
                            <div class="damage-box no-crit">
                                <div class="damage-box-title">
                                    <span class="tag tag-skill" id="tagSkill1">æŠ€èƒ½%</span>
                                    <span class="tag tag-no-crit">ç„¡å¿…æ®º</span>
                                </div>
                                <div class="damage-values">
                                    <div class="damage-stat min">
                                        <div class="damage-stat-label">æœ€å°</div>
                                        <div class="damage-stat-value" id="dmgSkill_NoCrit_Min">-</div>
                                    </div>
                                    <div class="damage-stat avg">
                                        <div class="damage-stat-label">å¹³å‡</div>
                                        <div class="damage-stat-value" id="dmgSkill_NoCrit_Avg">-</div>
                                    </div>
                                    <div class="damage-stat max">
                                        <div class="damage-stat-label">æœ€å¤§</div>
                                        <div class="damage-stat-value" id="dmgSkill_NoCrit_Max">-</div>
                                    </div>
                                </div>
                            </div>

                            <!-- æ™®æ”»å¿…æ®º (100%, æœ‰å¿…æ®º) -->
                            <div class="damage-box with-crit">
                                <div class="damage-box-title">
                                    <span class="tag tag-normal">æ™®æ”»100%</span>
                                    <span class="tag tag-crit">æœ‰å¿…æ®º</span>
                                </div>
                                <div class="damage-values">
                                    <div class="damage-stat min">
                                        <div class="damage-stat-label">æœ€å°</div>
                                        <div class="damage-stat-value" id="dmgNA_Crit_Min">-</div>
                                    </div>
                                    <div class="damage-stat avg">
                                        <div class="damage-stat-label">å¹³å‡</div>
                                        <div class="damage-stat-value" id="dmgNA_Crit_Avg">-</div>
                                    </div>
                                    <div class="damage-stat max">
                                        <div class="damage-stat-label">æœ€å¤§</div>
                                        <div class="damage-stat-value" id="dmgNA_Crit_Max">-</div>
                                    </div>
                                </div>
                            </div>

                            <!-- æŠ€èƒ½å¿…æ®º (æŠ€èƒ½%, æœ‰å¿…æ®º) -->
                            <div class="damage-box with-crit">
                                <div class="damage-box-title">
                                    <span class="tag tag-skill" id="tagSkill2">æŠ€èƒ½%</span>
                                    <span class="tag tag-crit">æœ‰å¿…æ®º</span>
                                </div>
                                <div class="damage-values">
                                    <div class="damage-stat min">
                                        <div class="damage-stat-label">æœ€å°</div>
                                        <div class="damage-stat-value" id="dmgSkill_Crit_Min">-</div>
                                    </div>
                                    <div class="damage-stat avg">
                                        <div class="damage-stat-label">å¹³å‡</div>
                                        <div class="damage-stat-value" id="dmgSkill_Crit_Avg">-</div>
                                    </div>
                                    <div class="damage-stat max">
                                        <div class="damage-stat-label">æœ€å¤§</div>
                                        <div class="damage-stat-value" id="dmgSkill_Crit_Max">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="damage-category">
                        <h4 class="damage-category-title">ğŸ‘¹ BOSSæˆ°å‚·å®³ï¼ˆå«æ”¹é€ å¢å‚·ï¼‰</h4>
                        <div class="damage-results-grid">
                            <!-- æ™®æ”»BOSS (100%, ç„¡å¿…æ®º) -->
                            <div class="damage-box with-boss">
                                <div class="damage-box-title">
                                    <span class="tag tag-normal">æ™®æ”»100%</span>
                                    <span class="tag tag-no-crit">ç„¡å¿…æ®º</span>
                                </div>
                                <div class="damage-values">
                                    <div class="damage-stat min">
                                        <div class="damage-stat-label">æœ€å°</div>
                                        <div class="damage-stat-value" id="dmgNA_Boss_Min">-</div>
                                    </div>
                                    <div class="damage-stat avg">
                                        <div class="damage-stat-label">å¹³å‡</div>
                                        <div class="damage-stat-value" id="dmgNA_Boss_Avg">-</div>
                                    </div>
                                    <div class="damage-stat max">
                                        <div class="damage-stat-label">æœ€å¤§</div>
                                        <div class="damage-stat-value" id="dmgNA_Boss_Max">-</div>
                                    </div>
                                </div>
                            </div>

                            <!-- æŠ€èƒ½BOSS (æŠ€èƒ½%, ç„¡å¿…æ®º) -->
                            <div class="damage-box with-boss">
                                <div class="damage-box-title">
                                    <span class="tag tag-skill" id="tagSkill3">æŠ€èƒ½%</span>
                                    <span class="tag tag-no-crit">ç„¡å¿…æ®º</span>
                                </div>
                                <div class="damage-values">
                                    <div class="damage-stat min">
                                        <div class="damage-stat-label">æœ€å°</div>
                                        <div class="damage-stat-value" id="dmgSkill_Boss_Min">-</div>
                                    </div>
                                    <div class="damage-stat avg">
                                        <div class="damage-stat-label">å¹³å‡</div>
                                        <div class="damage-stat-value" id="dmgSkill_Boss_Avg">-</div>
                                    </div>
                                    <div class="damage-stat max">
                                        <div class="damage-stat-label">æœ€å¤§</div>
                                        <div class="damage-stat-value" id="dmgSkill_Boss_Max">-</div>
                                    </div>
                                </div>
                            </div>

                            <!-- æ™®æ”»BOSSå¿…æ®º (100%, æœ‰å¿…æ®º) -->
                            <div class="damage-box highlight">
                                <div class="damage-box-title">
                                    <span class="tag tag-normal">æ™®æ”»100%</span>
                                    <span class="tag tag-crit">æœ‰å¿…æ®º</span>
                                </div>
                                <div class="damage-values">
                                    <div class="damage-stat min">
                                        <div class="damage-stat-label">æœ€å°</div>
                                        <div class="damage-stat-value" id="dmgNA_BossCrit_Min">-</div>
                                    </div>
                                    <div class="damage-stat avg">
                                        <div class="damage-stat-label">å¹³å‡</div>
                                        <div class="damage-stat-value" id="dmgNA_BossCrit_Avg">-</div>
                                    </div>
                                    <div class="damage-stat max">
                                        <div class="damage-stat-label">æœ€å¤§</div>
                                        <div class="damage-stat-value" id="dmgNA_BossCrit_Max">-</div>
                                    </div>
                                </div>
                            </div>

                            <!-- æŠ€èƒ½BOSSå¿…æ®º (æŠ€èƒ½%, æœ‰å¿…æ®º) - æœ€å¤§è¼¸å‡º -->
                            <div class="damage-box highlight">
                                <div class="damage-box-title">
                                    <span class="tag tag-skill" id="tagSkill4">æŠ€èƒ½%</span>
                                    <span class="tag tag-crit">æœ‰å¿…æ®º</span>
                                    ğŸ”¥
                                </div>
                                <div class="damage-values">
                                    <div class="damage-stat min">
                                        <div class="damage-stat-label">æœ€å°</div>
                                        <div class="damage-stat-value" id="dmgSkill_BossCrit_Min">-</div>
                                    </div>
                                    <div class="damage-stat avg">
                                        <div class="damage-stat-label">å¹³å‡</div>
                                        <div class="damage-stat-value" id="dmgSkill_BossCrit_Avg">-</div>
                                    </div>
                                    <div class="damage-stat max">
                                        <div class="damage-stat-label">æœ€å¤§</div>
                                        <div class="damage-stat-value" id="dmgSkill_BossCrit_Max">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- é­”æ³•å‚·å®³çµæœ -->
            <div class="results-section" id="magicResultsSection" style="display: none;">
                <div class="card results-card">
                    <div class="card-title">
                        <span>ğŸ”® é­”æ³•å‚·å®³è¨ˆç®—çµæœ</span>
                        <button class="formula-toggle" onclick="toggleMagicFormula()">ğŸ“ æŸ¥çœ‹å…¬å¼</button>
                    </div>

                    <!-- å…¬å¼èªªæ˜å€ -->
                    <div class="formula-section" id="magicFormulaSection">
                        <h4>ğŸ“ é­”æ³•å‚·å®³è¨ˆç®—å…¬å¼èªªæ˜</h4>
                        
                        <div class="formula-item">
                            <span class="formula-label">â‘  åŸºç¤å‚·å®³å€¼</span>
                            <span class="formula-code">
                                æ ¹æ“š<span class="formula-var">æ–½æ³•è€…é¡å‹</span>ï¼ˆäººç‰©/å¯µç‰©ï¼‰ã€<span class="formula-var">é­”æ³•é¡å‹</span>ï¼ˆå–®é«”/å¼·åŠ›/è¶…å¼·/å¸è¡€ï¼‰ã€<span class="formula-var">é­”æ³•ç­‰ç´š</span>æŸ¥è¡¨å–å¾—
                            </span>
                            <div class="formula-note">â€» EXæ³•ï¼š10ç­‰å‚·å®³ Ã— 1.13ï¼ˆåƒ…å¯µç‰©ï¼‰<br>â€» è³‡æ–™ä¾†æºï¼šé­”åŠ›ç™¾ç§‘</div>
                            <button class="formula-table-toggle" onclick="toggleMagicBaseDamageTable()">ğŸ“Š æŸ¥çœ‹åŸºç¤å‚·å®³å€¼è¡¨</button>
                            <div class="formula-table" id="magicBaseDamageTable">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>ç­‰ç´š</th>
                                            <th>äººç‰©å–®é«”</th>
                                            <th>äººç‰©å¼·åŠ›</th>
                                            <th>äººç‰©è¶…å¼·</th>
                                            <th>äººç‰©å¸è¡€</th>
                                            <th>å¯µç‰©å–®é«”</th>
                                            <th>å¯µç‰©å¼·åŠ›</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td>1ç­‰</td><td>95</td><td>57</td><td>38</td><td>63</td><td>86</td><td>51</td></tr>
                                        <tr><td>2ç­‰</td><td>171</td><td>103</td><td>68</td><td>114</td><td>154</td><td>93</td></tr>
                                        <tr><td>3ç­‰</td><td>239</td><td>143</td><td>96</td><td>159</td><td>215</td><td>129</td></tr>
                                        <tr><td>4ç­‰</td><td>303</td><td>182</td><td>121</td><td>202</td><td>273</td><td>164</td></tr>
                                        <tr><td>5ç­‰</td><td>368</td><td>221</td><td>147</td><td>245</td><td>331</td><td>199</td></tr>
                                        <tr><td>6ç­‰</td><td>432</td><td>259</td><td>173</td><td>288</td><td>389</td><td>233</td></tr>
                                        <tr><td>7ç­‰</td><td>497</td><td>298</td><td>199</td><td>331</td><td>447</td><td>268</td></tr>
                                        <tr><td>8ç­‰</td><td>570</td><td>342</td><td>228</td><td>380</td><td>513</td><td>307</td></tr>
                                        <tr><td>9ç­‰</td><td>646</td><td>388</td><td>258</td><td>430</td><td>581</td><td>349</td></tr>
                                        <tr><td>10ç­‰</td><td>722</td><td>433</td><td>289</td><td>481</td><td>650</td><td>390</td></tr>
                                        <tr><td>11ç­‰</td><td>791</td><td>475</td><td>316</td><td>522</td><td>-</td><td>-</td></tr>
                                        <tr><td>EX</td><td>-</td><td>-</td><td>-</td><td>-</td><td>735</td><td>441</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="formula-item">
                            <span class="formula-label">â‘¡ éœ€æ±‚ç²¾ç¥å€ç‡</span>
                            <span class="formula-code">
                                <span class="formula-var">éœ€æ±‚ç²¾ç¥</span> <span class="formula-op">=</span> 103 <span class="formula-op">+</span> <span class="formula-var">é­”æ³•ç­‰ç´š</span> <span class="formula-op">Ã—</span> 20<br>
                                è‹¥ <span class="formula-var">æ–½æ³•è€…ç²¾ç¥</span> <span class="formula-op">â‰¥</span> <span class="formula-var">éœ€æ±‚ç²¾ç¥</span>ï¼Œå‰‡ <span class="formula-var">ç²¾ç¥å€ç‡</span> <span class="formula-op">=</span> 100%<br>
                                å¦å‰‡ <span class="formula-var">ç²¾ç¥å€ç‡</span> <span class="formula-op">=</span> (<span class="formula-var">æ–½æ³•è€…ç²¾ç¥</span> <span class="formula-op">Ã·</span> <span class="formula-var">éœ€æ±‚ç²¾ç¥</span>) <span class="formula-op">Ã—</span> 100%
                            </span>
                        </div>

                        <div class="formula-item">
                            <span class="formula-label">â‘¢ ç²¾ç¥å·®è·å€ç‡</span>
                            <span class="formula-code">
                                æ ¹æ“š<span class="formula-var">æ–½æ³•è€…ç²¾ç¥</span>èˆ‡<span class="formula-var">å—æ³•è€…ç²¾ç¥</span>çš„å·®è·ç™¾åˆ†æ¯”æŸ¥è¡¨ï¼š<br>
                                20%ä»¥ä¸Š: 100% | 14%~20%: 90% | 5%~14%: 82% | 2~5%: 63%<br>
                                -2%~-10%: 55% | -10%~-20%: 36% | -20%~-30%: 27% | -30%ä»¥ä¸‹: 9%
                            </span>
                            <div class="formula-note">â€» å¯µç‰©é­”æ³•ï¼šæ­£å¸¸å€ç‡ > 36%ç¶­æŒåŸå€¼ï¼Œæ­£å¸¸å€ç‡ â‰¤ 36%é™åˆ¶ç‚º36%</div>
                        </div>

                        <div class="formula-item">
                            <span class="formula-label">â‘£ é­”æ”»å€ç‡ï¼ˆåƒ…äººç‰©ï¼‰</span>
                            <span class="formula-code">
                                æ ¹æ“š<span class="formula-var">é­”æ”»å€¼</span>å’Œ<span class="formula-var">é­”æ³•ç­‰ç´š</span>åœ¨ä¿‚æ•¸è¡¨ä¸­æŸ¥æ‰¾å°æ‡‰çš„<span class="formula-var">ä¿‚æ•¸</span>ï¼ˆ1.0 ~ 1.5ï¼‰<br>
                                <span class="formula-var">é ‚é­”æ”»éœ€æ±‚</span> <span class="formula-op">=</span> <span class="formula-var">é­”æ³•ç­‰ç´š</span> <span class="formula-op">Ã—</span> 34 <span class="formula-op">-</span> 20<br>
                                é”åˆ°é ‚é­”æ”»æ™‚ä¿‚æ•¸ç‚º 1.5ï¼ˆ150%ï¼‰ï¼Œæœªé”åˆ°æ™‚æ ¹æ“šä¿‚æ•¸è¡¨æŸ¥æ‰¾
                            </span>
                            <div class="formula-note">â€» å¯µç‰©å›ºå®šç‚º 100%ï¼ˆç„¡é­”æ”»åŠ æˆï¼‰</div>
                            <button class="formula-table-toggle" onclick="toggleMagicCoeffTable()">ğŸ“Š æŸ¥çœ‹é­”æ”»ä¿‚æ•¸è¡¨</button>
                            <div class="formula-table" id="magicCoeffTable">
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 8px;">
                                    ä¿‚æ•¸è¡¨ï¼šè¡Œ=ä¿‚æ•¸(1.0~1.5, æ­¥é•·0.0125)ï¼Œåˆ—=ç­‰ç´š(1~11)ï¼Œæ¯å€‹å–®å…ƒæ ¼æ˜¯è©²ç­‰ç´šåœ¨è©²ä¿‚æ•¸ä¸‹çš„é­”æ”»å€¼
                                </div>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>ä¿‚æ•¸</th>
                                            <th>1ç­‰</th>
                                            <th>2ç­‰</th>
                                            <th>3ç­‰</th>
                                            <th>4ç­‰</th>
                                            <th>5ç­‰</th>
                                            <th>6ç­‰</th>
                                            <th>7ç­‰</th>
                                            <th>8ç­‰</th>
                                            <th>9ç­‰</th>
                                            <th>10ç­‰</th>
                                            <th>11ç­‰</th>
                                        </tr>
                                    </thead>
                                    <tbody id="magicCoeffTableBody">
                                        <!-- å‹•æ…‹ç”Ÿæˆ -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="formula-item">
                            <span class="formula-label">â‘¤ PVEå¢å‚·ï¼ˆåƒ…å¯µç‰©ï¼‰</span>
                            <span class="formula-code">
                                è‹¥é–‹å•ŸPVEå¢å‚·ï¼Œå‰‡ <span class="formula-var">PVEå€ç‡</span> <span class="formula-op">=</span> 1.2ï¼ˆ120%ï¼‰<br>
                                å¦å‰‡ <span class="formula-var">PVEå€ç‡</span> <span class="formula-op">=</span> 1.0ï¼ˆ100%ï¼‰
                            </span>
                        </div>

                        <div class="formula-item main">
                            <span class="formula-label">â‘¥ å¯¦éš›é­”æ³•å‚·å®³å€¼ï¼ˆå®Œæ•´å…¬å¼ï¼‰</span>
                            <span class="formula-code">
                                <span class="formula-var">å¯¦éš›å‚·å®³</span> <span class="formula-op">=</span> [<span class="formula-var">åŸºç¤å‚·å®³</span> <span class="formula-op">Ã—</span> <span class="formula-var">æ°´æ™¶å±¬æ€§</span> <span class="formula-op">Ã—</span> <span class="formula-var">éš¨æ©Ÿå€¼(85%~115%)</span>] <span class="formula-op">Ã—</span> <span class="formula-var">éœ€æ±‚ç²¾ç¥å€ç‡</span> <span class="formula-op">Ã—</span> <span class="formula-var">ç²¾ç¥å·®è·å€ç‡</span> <span class="formula-op">Ã—</span> <span class="formula-var">äººç‰©é­”æ”»ä¿‚æ•¸</span> <span class="formula-op">Ã—</span> <span class="formula-var">å¯µç‰©PVEå¢å‚·</span> <span class="formula-op">Ã—</span> <span class="formula-var">ç¨®æ—å½±éŸ¿</span> <span class="formula-op">Ã—</span> <span class="formula-var">å¯µç‰©æ»¿æª”åŠ æˆ</span> <span class="formula-op">Ã—</span> <span class="formula-var">å¯µç‰©æ”¹é€ BOSSå¢å‚·</span> <span class="formula-op">Ã—</span> <span class="formula-var">é‡ç¸è¢«å‹•</span> <span class="formula-op">Ã—</span> <span class="formula-var">æ´æ‚‰æŠ€èƒ½</span>
                            </span>
                            <div class="formula-note">
                                â€» æ°´æ™¶å±¬æ€§ï¼šå…¨å‰‹=1.3ï¼ŒåŠå‰‹=1.15ï¼Œä¸ç›¸å‰‹=1.0ï¼Œè¢«åŠå‰‹=0.85ï¼Œè¢«å…¨å‰‹=0.7<br>
                                â€» é˜²å®ˆæ–¹å…¨å±¬æ€§2=1.06ï¼Œé˜²å®ˆæ–¹å…¨å±¬æ€§3=0.94ï¼Œé˜²å®ˆæ–¹å…¨å±¬æ€§4=0.82ï¼Œé˜²å®ˆæ–¹å…¨å±¬æ€§5=0.7<br>
                                â€» ç¨®æ—å½±éŸ¿ï¼šå…¨å‰‹=1.2ï¼ŒåŠå‰‹=1.1ï¼Œä¸ç›¸å‰‹=1.0ï¼Œè¢«åŠå‰‹=0.9ï¼Œè¢«å…¨å‰‹=0.8<br>
                                â€» å¯µç‰©æ»¿æª”åŠ æˆï¼šæ™®å¡+10%ï¼ŒéŠ€å¡+15%ï¼Œé‡‘å¡+20%<br>
                                â€» å¯µç‰©æ”¹é€ BOSSå¢å‚·ï¼šæ ¹æ“šæ”¹é€ ç­‰ç´šå’Œå¡åˆ¥ï¼Œåƒ…åœ¨BOSSæˆ°æ™‚ç”Ÿæ•ˆ<br>
                                â€» é‡ç¸è¢«å‹•ï¼šæ™®å¡+3%ï¼ŒéŠ€å¡+5%ï¼Œé‡‘å¡+8%<br>
                                â€» æ´æ‚‰æŠ€èƒ½ï¼šé™ä½æ‰€å—é­”æ³•å‚·å®³ï¼Œæ¯ç­‰ç´š-1%ï¼ˆ1ç­‰-1%ï¼Œ11ç­‰-11%ï¼‰<br>
                                <br>
                                <strong>ä¸‰ç¨®æƒ…æ³å€åˆ†ï¼š</strong><br>
                                â€¢ <strong>ä¸€èˆ¬é‡å¤–æ‰“æ€ª</strong>ï¼šå¯µç‰©PVEåŠ æˆç”Ÿæ•ˆï¼Œç¨®æ—å½±éŸ¿æ­£å¸¸ï¼Œç„¡æ”¹é€ åŠ æˆ<br>
                                â€¢ <strong>PK</strong>ï¼šç„¡å¯µç‰©PVEåŠ æˆï¼Œç¨®æ—å½±éŸ¿æ¸›åŠï¼Œç„¡æ”¹é€ åŠ æˆ<br>
                                â€¢ <strong>BOSSæˆ°</strong>ï¼šå¯µç‰©PVEåŠ æˆç”Ÿæ•ˆï¼Œç¨®æ—å½±éŸ¿æ­£å¸¸ï¼Œæœ‰æ”¹é€ åŠ æˆ
                            </div>
                        </div>
                    </div>
                    
                    <!-- åŸºç¤æ•¸å€¼ -->
                    <div class="base-results">
                        <div class="base-result-item">
                            <div class="base-result-label">åŸºç¤å‚·å®³</div>
                            <div class="base-result-value" id="magicBaseDamage">-</div>
                        </div>
                        <div class="base-result-item">
                            <div class="base-result-label">éœ€æ±‚ç²¾ç¥å€ç‡</div>
                            <div class="base-result-value" id="magicSpiritMultiplier">-</div>
                        </div>
                        <div class="base-result-item">
                            <div class="base-result-label">ç²¾ç¥å·®è·å€ç‡</div>
                            <div class="base-result-value" id="magicSpiritDiffMultiplier">-</div>
                        </div>
                        <div class="base-result-item">
                            <div class="base-result-label">é­”æ”»å€ç‡</div>
                            <div class="base-result-value" id="magicAttackMultiplier">-</div>
                        </div>
                    </div>
                    
                    <!-- ä¿®æ­£å€¼ -->
                    <div class="modifier-section">
                        <div class="modifier-item">
                            <span class="modifier-label">ğŸ’ æ°´æ™¶å±¬æ€§</span>
                            <span class="modifier-value" id="magicModCrystal">-</span>
                        </div>
                        <div class="modifier-item">
                            <span class="modifier-label">ğŸ‘¾ ç¨®æ—å½±éŸ¿</span>
                            <span class="modifier-value" id="magicModRace">-</span>
                        </div>
                        <div class="modifier-item" id="magicModMaxStats" style="display: none;">
                            <span class="modifier-label">ğŸ“Š æ»¿æª”åŠ ä¹˜</span>
                            <span class="modifier-value">-</span>
                        </div>
                        <div class="modifier-item" id="magicModReform" style="display: none;">
                            <span class="modifier-label">ğŸ”§ æ”¹é€ BOSSå¢å‚·</span>
                            <span class="modifier-value">-</span>
                        </div>
                        <div class="modifier-item" id="magicModBeast" style="display: none;">
                            <span class="modifier-label">ğŸº é‡ç¸è¢«å‹•</span>
                            <span class="modifier-value">-</span>
                        </div>
                        <div class="modifier-item" id="magicModInsight">
                            <span class="modifier-label">ğŸ›¡ï¸ æ´æ‚‰æŠ€èƒ½</span>
                            <span class="modifier-value">-</span>
                        </div>
                    </div>
                    
                    <!-- å‚·å®³çµæœ -->
                    <div class="damage-category">
                        <h4 class="damage-category-title">ğŸŒ² ä¸€èˆ¬é‡å¤–æ‰“æ€ªï¼ˆå¯µç‰©PVEåŠ æˆï¼‰</h4>
                        <div class="damage-results-grid">
                            <div class="damage-box highlight">
                                <div class="damage-box-title">
                                    <span class="tag tag-skill" id="magicTagTypeNormal">å–®é«”é­”æ³•</span>
                                </div>
                                <div class="damage-values">
                                    <div class="damage-stat min">
                                        <div class="damage-stat-label">æœ€å°</div>
                                        <div class="damage-stat-value" id="magicDmgNormalMin">-</div>
                                    </div>
                                    <div class="damage-stat avg">
                                        <div class="damage-stat-label">å¹³å‡</div>
                                        <div class="damage-stat-value" id="magicDmgNormalAvg">-</div>
                                    </div>
                                    <div class="damage-stat max">
                                        <div class="damage-stat-label">æœ€å¤§</div>
                                        <div class="damage-stat-value" id="magicDmgNormalMax">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="damage-category">
                        <h4 class="damage-category-title">âš”ï¸ PKï¼ˆç¨®æ—å…‹åˆ¶æ•ˆæœæ¸›åŠï¼‰</h4>
                        <div class="damage-results-grid">
                            <div class="damage-box highlight">
                                <div class="damage-box-title">
                                    <span class="tag tag-skill" id="magicTagTypePK">å–®é«”é­”æ³•</span>
                                </div>
                                <div class="damage-values">
                                    <div class="damage-stat min">
                                        <div class="damage-stat-label">æœ€å°</div>
                                        <div class="damage-stat-value" id="magicDmgPKMin">-</div>
                                    </div>
                                    <div class="damage-stat avg">
                                        <div class="damage-stat-label">å¹³å‡</div>
                                        <div class="damage-stat-value" id="magicDmgPKAvg">-</div>
                                    </div>
                                    <div class="damage-stat max">
                                        <div class="damage-stat-label">æœ€å¤§</div>
                                        <div class="damage-stat-value" id="magicDmgPKMax">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="damage-category">
                        <h4 class="damage-category-title">ğŸ‘¹ BOSSæˆ°ï¼ˆå¯µç‰©PVEåŠæ”¹é€ åŠ æˆï¼‰</h4>
                        <div class="damage-results-grid">
                            <div class="damage-box highlight">
                                <div class="damage-box-title">
                                    <span class="tag tag-skill" id="magicTagTypeBoss">å–®é«”é­”æ³•</span>
                                </div>
                                <div class="damage-values">
                                    <div class="damage-stat min">
                                        <div class="damage-stat-label">æœ€å°</div>
                                        <div class="damage-stat-value" id="magicDmgBossMin">-</div>
                                    </div>
                                    <div class="damage-stat avg">
                                        <div class="damage-stat-label">å¹³å‡</div>
                                        <div class="damage-stat-value" id="magicDmgBossAvg">-</div>
                                    </div>
                                    <div class="damage-stat max">
                                        <div class="damage-stat-label">æœ€å¤§</div>
                                        <div class="damage-stat-value" id="magicDmgBossMax">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ¯”è¼ƒæ¸…å–® -->
            <div class="results-section">
                <div class="card compare-list-card">
                    <div class="card-title">
                        <span>ğŸ“‹ æ¯”è¼ƒæ¸…å–®</span>
                        <button class="btn-clear-list" onclick="clearCompareList()">æ¸…ç©ºæ¸…å–®</button>
                    </div>
                    
                    <div id="compareListContent">
                        <div class="compare-list-empty" id="compareListEmpty">
                            <div class="icon">ğŸ“</div>
                            <p>å°šç„¡æ¯”è¼ƒè¨˜éŒ„</p>
                            <p style="font-size: 0.9rem; margin-top: 5px;">è¨ˆç®—å¾Œé»æ“Šã€ŒåŠ å…¥æ¯”è¼ƒæ¸…å–®ã€ä¾†æ–°å¢è¨˜éŒ„</p>
                        </div>
                        
                        <div class="compare-list-scroll" id="compareListScroll" style="display: none;">
                            <table class="compare-list-table">
                                <thead>
                                    <tr>
                                        <th rowspan="2">åç¨±</th>
                                        <th rowspan="2">æ”»/é˜²</th>
                                        <th rowspan="2">æ­¦å™¨</th>
                                        <th rowspan="2">å±¬æ€§</th>
                                        <th rowspan="2">ç¨®æ—</th>
                                        <th rowspan="2">å¡åˆ¥</th>
                                        <th rowspan="2">æ»¿æª”</th>
                                        <th rowspan="2">é‡ç¸</th>
                                        <th rowspan="2">æ”¹é€ </th>
                                        <th rowspan="2">æŠ€èƒ½%</th>
                                        <th colspan="2">ä¸€èˆ¬å‚·å®³</th>
                                        <th colspan="2">å¿…æ®ºå‚·å®³</th>
                                        <th colspan="2">BOSSå‚·</th>
                                        <th colspan="2">BOSSå¿…æ®º</th>
                                        <th rowspan="2">æ“ä½œ</th>
                                    </tr>
                                    <tr>
                                        <th>æ™®æ”»</th>
                                        <th>æŠ€èƒ½</th>
                                        <th>æ™®æ”»</th>
                                        <th>æŠ€èƒ½</th>
                                        <th>æ™®æ”»</th>
                                        <th>æŠ€èƒ½</th>
                                        <th>æ™®æ”»</th>
                                        <th>æŠ€èƒ½</th>
                                    </tr>
                                </thead>
                                <tbody id="compareListBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è³‡æ–™è¡¨
        const maxStatsBonusTable = { normal: 0.10, silver: 0.15, gold: 0.20 };
        const petReformBonusTable = {
            0: { normal: 0, silver: 0, gold: 0 },
            1: { normal: 0.06, silver: 0.09, gold: 0.13 },
            2: { normal: 0.09, silver: 0.13, gold: 0.18 },
            3: { normal: 0.12, silver: 0.17, gold: 0.23 },
            4: { normal: 0.16, silver: 0.22, gold: 0.29 },
            5: { normal: 0.20, silver: 0.27, gold: 0.35 }
        };
        const beastPassiveBonusTable = { normal: 0.03, silver: 0.05, gold: 0.08 };
        const gradeNames = { normal: 'æ™®å¡', silver: 'éŠ€å¡', gold: 'é‡‘å¡' };
        const reformLabels = ['æœªæ”¹', 'ä¸€æ”¹', 'äºŒæ”¹', 'ä¸‰æ”¹', 'å››æ”¹', 'äº”æ”¹'];

        // é­”æ³•å‚·å®³æ•¸æ“šè¡¨
        const magicBaseDamageTable = {
            character: {
                single: { 1: 95, 2: 171, 3: 239, 4: 303, 5: 368, 6: 432, 7: 497, 8: 570, 9: 646, 10: 722, 11: 791 },
                strong: { 1: 57, 2: 103, 3: 143, 4: 182, 5: 221, 6: 259, 7: 298, 8: 342, 9: 388, 10: 433, 11: 475 },
                super: { 1: 38, 2: 68, 3: 96, 4: 121, 5: 147, 6: 173, 7: 199, 8: 228, 9: 258, 10: 289, 11: 316 },
                drain: { 1: 63, 2: 114, 3: 159, 4: 202, 5: 245, 6: 288, 7: 331, 8: 380, 9: 430, 10: 481, 11: 522 }
            },
            pet: {
                single: { 1: 86, 2: 154, 3: 215, 4: 273, 5: 331, 6: 389, 7: 447, 8: 513, 9: 581, 10: 650 },
                strong: { 1: 51, 2: 93, 3: 129, 4: 164, 5: 199, 6: 233, 7: 268, 8: 307, 9: 349, 10: 390 }
            }
        };

        const magicTypeNames = {
            single: 'å–®é«”é­”æ³•',
            strong: 'å¼·åŠ›é­”æ³•',
            super: 'è¶…å¼·é­”æ³•',
            drain: 'å¸è¡€é­”æ³•'
        };

        // é­”æ”»åŠ æˆä¿‚æ•¸æŸ¥æ‰¾è¡¨ï¼ˆæ ¹æ“šExcelè¡¨æ ¼ coeff_1_11.xlsxï¼‰
        // è¡¨æ ¼çµæ§‹ï¼šè¡Œ=ä¿‚æ•¸(1.0~1.5, æ­¥é•·0.0125)ï¼Œåˆ—=ç­‰ç´š(1~11)
        // æ¯å€‹å–®å…ƒæ ¼æ˜¯è©²ç­‰ç´šåœ¨è©²ä¿‚æ•¸ä¸‹çš„é­”æ”»å€¼
        const magicAttackLookupTable = {
            1: { 1.0: 10, 1.0125: 10, 1.025: 10, 1.0375: 10, 1.05: 10, 1.0625: 10, 1.075: 10, 1.0875: 10, 1.1: 10, 1.1125: 11, 1.125: 11, 1.1375: 11, 1.15: 11, 1.1625: 11, 1.175: 11, 1.1875: 11, 1.2: 11, 1.2125: 11, 1.225: 11, 1.2375: 11, 1.25: 12, 1.2625: 12, 1.275: 12, 1.2875: 12, 1.3: 12, 1.3125: 12, 1.325: 12, 1.3375: 12, 1.35: 12, 1.3625: 12, 1.375: 13, 1.3875: 13, 1.4: 13, 1.4125: 13, 1.425: 13, 1.4375: 13, 1.45: 13, 1.4625: 13, 1.475: 13, 1.4875: 13, 1.5: 14 },
            2: { 1.0: 40, 1.0125: 40, 1.025: 40, 1.0375: 40, 1.05: 40, 1.0625: 41, 1.075: 41, 1.0875: 41, 1.1: 41, 1.1125: 41, 1.125: 42, 1.1375: 42, 1.15: 42, 1.1625: 42, 1.175: 42, 1.1875: 43, 1.2: 43, 1.2125: 43, 1.225: 43, 1.2375: 43, 1.25: 44, 1.2625: 44, 1.275: 44, 1.2875: 44, 1.3: 44, 1.3125: 45, 1.325: 45, 1.3375: 45, 1.35: 45, 1.3625: 45, 1.375: 46, 1.3875: 46, 1.4: 46, 1.4125: 46, 1.425: 46, 1.4375: 47, 1.45: 47, 1.4625: 47, 1.475: 47, 1.4875: 47, 1.5: 48 },
            3: { 1.0: 70, 1.0125: 70, 1.025: 70, 1.0375: 71, 1.05: 71, 1.0625: 71, 1.075: 71, 1.0875: 72, 1.1: 72, 1.1125: 72, 1.125: 73, 1.1375: 73, 1.15: 73, 1.1625: 74, 1.175: 74, 1.1875: 74, 1.2: 74, 1.2125: 75, 1.225: 75, 1.2375: 75, 1.25: 76, 1.2625: 76, 1.275: 76, 1.2875: 77, 1.3: 77, 1.3125: 77, 1.325: 77, 1.3375: 78, 1.35: 78, 1.3625: 78, 1.375: 79, 1.3875: 79, 1.4: 79, 1.4125: 80, 1.425: 80, 1.4375: 80, 1.45: 80, 1.4625: 81, 1.475: 81, 1.4875: 81, 1.5: 82 },
            4: { 1.0: 100, 1.0125: 100, 1.025: 101, 1.0375: 101, 1.05: 101, 1.0625: 102, 1.075: 102, 1.0875: 103, 1.1: 103, 1.1125: 103, 1.125: 104, 1.1375: 104, 1.15: 105, 1.1625: 105, 1.175: 105, 1.1875: 106, 1.2: 106, 1.2125: 107, 1.225: 107, 1.2375: 107, 1.25: 108, 1.2625: 108, 1.275: 109, 1.2875: 109, 1.3: 109, 1.3125: 110, 1.325: 110, 1.3375: 111, 1.35: 111, 1.3625: 111, 1.375: 112, 1.3875: 112, 1.4: 113, 1.4125: 113, 1.425: 113, 1.4375: 114, 1.45: 114, 1.4625: 115, 1.475: 115, 1.4875: 115, 1.5: 116 },
            5: { 1.0: 130, 1.0125: 130, 1.025: 131, 1.0375: 131, 1.05: 132, 1.0625: 132, 1.075: 133, 1.0875: 133, 1.1: 134, 1.1125: 134, 1.125: 135, 1.1375: 135, 1.15: 136, 1.1625: 136, 1.175: 137, 1.1875: 137, 1.2: 138, 1.2125: 138, 1.225: 139, 1.2375: 139, 1.25: 140, 1.2625: 140, 1.275: 141, 1.2875: 141, 1.3: 142, 1.3125: 142, 1.325: 143, 1.3375: 143, 1.35: 144, 1.3625: 144, 1.375: 145, 1.3875: 145, 1.4: 146, 1.4125: 146, 1.425: 147, 1.4375: 147, 1.45: 148, 1.4625: 148, 1.475: 149, 1.4875: 149, 1.5: 150 },
            6: { 1.0: 160, 1.0125: 160, 1.025: 161, 1.0375: 162, 1.05: 162, 1.0625: 163, 1.075: 163, 1.0875: 164, 1.1: 165, 1.1125: 165, 1.125: 166, 1.1375: 166, 1.15: 167, 1.1625: 168, 1.175: 168, 1.1875: 169, 1.2: 169, 1.2125: 170, 1.225: 171, 1.2375: 171, 1.25: 172, 1.2625: 172, 1.275: 173, 1.2875: 174, 1.3: 174, 1.3125: 175, 1.325: 175, 1.3375: 176, 1.35: 177, 1.3625: 177, 1.375: 178, 1.3875: 178, 1.4: 179, 1.4125: 180, 1.425: 180, 1.4375: 181, 1.45: 181, 1.4625: 182, 1.475: 183, 1.4875: 183, 1.5: 184 },
            7: { 1.0: 190, 1.0125: 191, 1.025: 191, 1.0375: 192, 1.05: 193, 1.0625: 193, 1.075: 194, 1.0875: 195, 1.1: 195, 1.1125: 196, 1.125: 197, 1.1375: 198, 1.15: 198, 1.1625: 199, 1.175: 200, 1.1875: 200, 1.2: 201, 1.2125: 202, 1.225: 202, 1.2375: 203, 1.25: 204, 1.2625: 205, 1.275: 205, 1.2875: 206, 1.3: 207, 1.3125: 207, 1.325: 208, 1.3375: 209, 1.35: 209, 1.3625: 210, 1.375: 211, 1.3875: 212, 1.4: 212, 1.4125: 213, 1.425: 214, 1.4375: 214, 1.45: 215, 1.4625: 216, 1.475: 216, 1.4875: 217, 1.5: 218 },
            8: { 1.0: 220, 1.0125: 221, 1.025: 222, 1.0375: 222, 1.05: 223, 1.0625: 224, 1.075: 225, 1.0875: 226, 1.1: 226, 1.1125: 227, 1.125: 228, 1.1375: 229, 1.15: 230, 1.1625: 230, 1.175: 231, 1.1875: 232, 1.2: 233, 1.2125: 234, 1.225: 234, 1.2375: 235, 1.25: 236, 1.2625: 237, 1.275: 238, 1.2875: 238, 1.3: 239, 1.3125: 240, 1.325: 241, 1.3375: 242, 1.35: 242, 1.3625: 243, 1.375: 244, 1.3875: 245, 1.4: 246, 1.4125: 246, 1.425: 247, 1.4375: 248, 1.45: 249, 1.4625: 250, 1.475: 250, 1.4875: 251, 1.5: 252 },
            9: { 1.0: 250, 1.0125: 251, 1.025: 252, 1.0375: 253, 1.05: 254, 1.0625: 254, 1.075: 255, 1.0875: 256, 1.1: 257, 1.1125: 258, 1.125: 259, 1.1375: 260, 1.15: 261, 1.1625: 262, 1.175: 263, 1.1875: 263, 1.2: 264, 1.2125: 265, 1.225: 266, 1.2375: 267, 1.25: 268, 1.2625: 269, 1.275: 270, 1.2875: 271, 1.3: 272, 1.3125: 272, 1.325: 273, 1.3375: 274, 1.35: 275, 1.3625: 276, 1.375: 277, 1.3875: 278, 1.4: 279, 1.4125: 280, 1.425: 281, 1.4375: 281, 1.45: 282, 1.4625: 283, 1.475: 284, 1.4875: 285, 1.5: 286 },
            10: { 1.0: 280, 1.0125: 281, 1.025: 282, 1.0375: 283, 1.05: 284, 1.0625: 285, 1.075: 286, 1.0875: 287, 1.1: 288, 1.1125: 289, 1.125: 290, 1.1375: 291, 1.15: 292, 1.1625: 293, 1.175: 294, 1.1875: 295, 1.2: 296, 1.2125: 297, 1.225: 298, 1.2375: 299, 1.25: 300, 1.2625: 301, 1.275: 302, 1.2875: 303, 1.3: 304, 1.3125: 305, 1.325: 306, 1.3375: 307, 1.35: 308, 1.3625: 309, 1.375: 310, 1.3875: 311, 1.4: 312, 1.4125: 313, 1.425: 314, 1.4375: 315, 1.45: 316, 1.4625: 317, 1.475: 318, 1.4875: 319, 1.5: 320 },
            11: { 1.0: 310, 1.0125: 311, 1.025: 312, 1.0375: 313, 1.05: 314, 1.0625: 316, 1.075: 317, 1.0875: 318, 1.1: 319, 1.1125: 320, 1.125: 321, 1.1375: 322, 1.15: 323, 1.1625: 324, 1.175: 325, 1.1875: 326, 1.2: 328, 1.2125: 329, 1.225: 330, 1.2375: 331, 1.25: 332, 1.2625: 333, 1.275: 334, 1.2875: 335, 1.3: 336, 1.3125: 338, 1.325: 339, 1.3375: 340, 1.35: 341, 1.3625: 342, 1.375: 343, 1.3875: 344, 1.4: 345, 1.4125: 346, 1.425: 347, 1.4375: 348, 1.45: 350, 1.4625: 351, 1.475: 352, 1.4875: 353, 1.5: 354 }
        };

        // æ ¹æ“šé­”æ”»å€¼å’Œç­‰ç´šæŸ¥æ‰¾å°æ‡‰çš„ä¿‚æ•¸
        function getMagicAttackCoefficient(magicAttack, level) {
            const requiredAttack = level * 34 - 20; // é ‚é­”æ”»éœ€æ±‚
            
            // å¦‚æœé”åˆ°æˆ–è¶…éé ‚é­”æ”»ï¼Œä¿‚æ•¸ç‚º1.5ï¼ˆ150%ï¼‰
            if (magicAttack >= requiredAttack) {
                return 1.5;
            }
            
            // å¦‚æœæ²’æœ‰é­”æ”»ï¼Œä¿‚æ•¸ç‚º1.0ï¼ˆ100%ï¼‰
            if (magicAttack <= 0) {
                return 1.0;
            }
            
            // å¦‚æœæœ‰è©²ç­‰ç´šçš„æŸ¥æ‰¾è¡¨ï¼Œä½¿ç”¨æŸ¥æ‰¾è¡¨
            if (magicAttackLookupTable[level]) {
                const levelTable = magicAttackLookupTable[level];
                
                // å°‡æŸ¥æ‰¾è¡¨è½‰æ›ç‚ºæ•¸çµ„ä¸¦æŒ‰é­”æ”»å€¼æ’åº
                const sortedEntries = Object.entries(levelTable)
                    .map(([coeff, val]) => [parseFloat(coeff), parseInt(val)])
                    .sort((a, b) => a[1] - b[1]);
                
                // å¦‚æœé­”æ”»å€¼å°æ–¼æœ€å°å€¼ï¼Œè¿”å›æœ€å°ä¿‚æ•¸
                if (magicAttack < sortedEntries[0][1]) {
                    return sortedEntries[0][0];
                }
                
                // å¦‚æœé­”æ”»å€¼å¤§æ–¼æœ€å¤§å€¼ï¼Œè¿”å›æœ€å¤§ä¿‚æ•¸
                if (magicAttack >= sortedEntries[sortedEntries.length - 1][1]) {
                    return sortedEntries[sortedEntries.length - 1][0];
                }
                
                // æŸ¥æ‰¾åŒ…å«è©²é­”æ”»å€¼çš„å€é–“ä¸¦é€²è¡Œç·šæ€§æ’å€¼
                for (let i = 0; i < sortedEntries.length - 1; i++) {
                    const [coeff1, val1] = sortedEntries[i];
                    const [coeff2, val2] = sortedEntries[i + 1];
                    
                    if (magicAttack >= val1 && magicAttack < val2) {
                        if (val2 === val1) {
                            return coeff1; // å¦‚æœå€é–“ç‚º0ï¼Œç›´æ¥è¿”å›ä¿‚æ•¸
                        }
                        const ratio = (magicAttack - val1) / (val2 - val1);
                        return coeff1 + (coeff2 - coeff1) * ratio;
                    }
                }
                
                // å¦‚æœæ­£å¥½ç­‰æ–¼æœ€å¾Œä¸€å€‹å€¼
                return sortedEntries[sortedEntries.length - 1][0];
            }
            
            // å¦‚æœæ²’æœ‰æŸ¥æ‰¾è¡¨æ•¸æ“šï¼Œä½¿ç”¨ç·šæ€§æ’å€¼ï¼ˆå‚™ç”¨æ–¹æ¡ˆï¼‰
            const ratio = magicAttack / requiredAttack;
            return 1.0 + ratio * 0.5; // å¾100%ç·šæ€§æ’å€¼åˆ°150%
        }

        // æ›´æ–°é­”æ³•é¸é …
        function updateMagicOptions() {
            const casterType = document.getElementById('magicCasterType').value;
            const magicTypeSelect = document.getElementById('magicType');
            const magicLevelSelect = document.getElementById('magicLevel');
            const pveGroup = document.getElementById('magicPVEGroup');
            const magicAttackInput = document.getElementById('magicAttack').parentElement;
            const petOptions = document.getElementById('magicPetOptions');
            
            // é¡¯ç¤º/éš±è—PVEé–‹é—œå’Œå¯µç‰©é¸é …
            if (casterType === 'pet') {
                pveGroup.style.display = 'flex';
                petOptions.style.display = 'block';
            } else {
                pveGroup.style.display = 'none';
                petOptions.style.display = 'none';
                document.getElementById('magicPVE').checked = false;
            }
            
            // æ›´æ–°é­”æ³•é¡å‹é¸é …
            const superOption = document.getElementById('magicTypeSuper');
            const drainOption = document.getElementById('magicTypeDrain');
            
            if (casterType === 'pet') {
                superOption.style.display = 'none';
                drainOption.style.display = 'none';
                // å¦‚æœç•¶å‰é¸ä¸­ä¸å­˜åœ¨çš„é¸é …ï¼Œåˆ‡æ›åˆ°å–®é«”
                if (magicTypeSelect.value === 'super' || magicTypeSelect.value === 'drain') {
                    magicTypeSelect.value = 'single';
                }
            } else {
                superOption.style.display = 'block';
                drainOption.style.display = 'block';
            }
            
            updateMagicLevelOptions();
        }

        // æ›´æ–°é­”æ³•ç­‰ç´šé¸é …
        function updateMagicLevelOptions() {
            const casterType = document.getElementById('magicCasterType').value;
            const magicType = document.getElementById('magicType').value;
            const magicLevelSelect = document.getElementById('magicLevel');
            const level11Option = document.getElementById('magicLevel11');
            const levelExOption = document.getElementById('magicLevelEx');
            
            if (casterType === 'pet') {
                level11Option.style.display = 'none';
                levelExOption.style.display = 'block';
                // å¦‚æœç•¶å‰é¸ä¸­11ç­‰ï¼Œåˆ‡æ›åˆ°10ç­‰
                if (magicLevelSelect.value === '11') {
                    magicLevelSelect.value = '10';
                }
            } else {
                level11Option.style.display = 'block';
                levelExOption.style.display = 'none';
                // å¦‚æœç•¶å‰é¸ä¸­EXï¼Œåˆ‡æ›åˆ°10ç­‰
                if (magicLevelSelect.value === 'ex') {
                    magicLevelSelect.value = '10';
                }
            }
        }

        // ç²¾ç¥å·®è·å€ç‡è¡¨
        function getSpiritDiffMultiplier(casterSpirit, targetSpirit) {
            if (targetSpirit === 0) return 1.0;
            const diff = ((casterSpirit - targetSpirit) / targetSpirit) * 100;
            
            // æ–½æ³•è€…ç²¾ç¥é«˜å—æ³•è€…ç²¾ç¥
            if (diff >= 20) return 1.0;        // 20%ä»¥ä¸Š: 100%
            if (diff >= 14) return 0.9;        // 14%~20%: 90% (14 <= diff < 20)
            if (diff >= 5) return 0.82;        // 5%~14%: 82% (5 <= diff < 14)
            if (diff >= 2) return 0.63;        // 2~5%: 63% (2 <= diff < 5)
            if (diff >= -10) return 0.55;      // -10%~2%: 55% (-10 <= diff < 2ï¼ŒåŒ…å«-2%~-10%å’Œ-2%~2%)
            if (diff >= -20) return 0.36;      // -20%~-10%: 36% (-20 <= diff < -10)
            if (diff >= -30) return 0.27;      // -30%~-20%: 27% (-30 <= diff < -20)
            return 0.09;                       // -30%ä»¥ä¸‹: 9% (diff < -30)
        }

        // å¯µç‰©ç²¾ç¥å·®è·å€ç‡ï¼ˆæœ€ä½36%ï¼Œå³ç²¾ç¥å·®å½±éŸ¿æœ€ä½èƒ½ç™¼å‹•36%ï¼‰
        function getPetSpiritDiffMultiplier(casterSpirit, targetSpirit) {
            // å…ˆè¨ˆç®—æ­£å¸¸çš„ç²¾ç¥å·®è·å€ç‡
            const normalMultiplier = getSpiritDiffMultiplier(casterSpirit, targetSpirit);
            // æ­£å¸¸å€ç‡ > 36%ï¼ˆå¦‚ 100%ã€90%ã€82%ã€63%ã€55%ï¼‰â†’ ç¶­æŒåŸå€¼
            // æ­£å¸¸å€ç‡ â‰¤ 36%ï¼ˆå¦‚ 36%ã€27%ã€9%ï¼‰â†’ é™åˆ¶ç‚º 36%
            return Math.max(normalMultiplier, 0.36);
        }

        // é­”æ³•å‚·å®³è¨ˆç®—
        function calculateMagic() {
            const casterType = document.getElementById('magicCasterType').value;
            const magicType = document.getElementById('magicType').value;
            const levelValue = document.getElementById('magicLevel').value;
            const isEx = levelValue === 'ex';
            const level = isEx ? 10 : parseInt(levelValue); // EXæ³•ä½¿ç”¨10ç­‰çš„ç²¾ç¥éœ€æ±‚
            const casterSpirit = parseFloat(document.getElementById('magicCasterSpirit').value) || 0;
            const targetSpirit = parseFloat(document.getElementById('magicTargetSpirit').value) || 0;
            const magicAttack = parseFloat(document.getElementById('magicAttack').value) || 0;
            const crystalElement = parseFloat(document.getElementById('magicCrystalElement').value);
            const raceEffect = parseFloat(document.getElementById('magicRaceEffect').value);
            const isPVE = document.getElementById('magicPVE').checked;
            const insightLevel = parseInt(document.getElementById('magicInsightLevel').value) || 0;
            
            // å¯µç‰©ç›¸é—œåƒæ•¸
            const petGrade = document.getElementById('magicPetGrade').value;
            const isMaxStats = document.getElementById('magicMaxStats').checked;
            const isBeast = document.getElementById('magicBeastPassive').checked;
            const petReformLevel = parseInt(document.getElementById('magicPetReform').value) || 0;

            // åŸºç¤å‚·å®³
            let baseDamage;
            if (isEx && casterType === 'pet') {
                // EXæ³•ï¼š10ç­‰å‚·å®³ Ã— 1.13
                const base10 = magicBaseDamageTable[casterType][magicType][10];
                baseDamage = Math.round(base10 * 1.13);
            } else {
                baseDamage = magicBaseDamageTable[casterType][magicType][level];
            }
            
            if (!baseDamage) {
                alert('ç„¡æ•ˆçš„é­”æ³•ç­‰ç´šæˆ–é¡å‹');
                return;
            }

            // éœ€æ±‚ç²¾ç¥å€ç‡ï¼ˆEXæ³•ä½¿ç”¨10ç­‰çš„ç²¾ç¥éœ€æ±‚ï¼‰
            const requiredSpirit = 103 + level * 20;
            const spiritMultiplier = casterSpirit >= requiredSpirit ? 1.0 : (casterSpirit / requiredSpirit);

            // ç²¾ç¥å·®è·å€ç‡
            const spiritDiffMultiplier = casterType === 'pet' 
                ? getPetSpiritDiffMultiplier(casterSpirit, targetSpirit)
                : getSpiritDiffMultiplier(casterSpirit, targetSpirit);

            // é­”æ”»å€ç‡ï¼ˆä½¿ç”¨ä¿‚æ•¸æŸ¥æ‰¾è¡¨ï¼‰
            let attackMultiplier = 1.0;
            if (casterType === 'character') {
                // æ ¹æ“šé­”æ”»å€¼å’Œç­‰ç´šæŸ¥æ‰¾å°æ‡‰çš„ä¿‚æ•¸
                const coeff = getMagicAttackCoefficient(magicAttack, level);
                attackMultiplier = coeff; // ä¿‚æ•¸ç›´æ¥ä½œç‚ºå€ç‡ï¼ˆ1.0 = 100%, 1.5 = 150%ï¼‰
            } else {
                attackMultiplier = 1.0; // å¯µç‰©å›ºå®š100%
            }

            // PVEå¢å‚·ï¼ˆåƒ…å¯µç‰©ï¼‰
            const pveMultiplier = (casterType === 'pet' && isPVE) ? 1.2 : 1.0;

            // æ°´æ™¶å±¬æ€§ä¿®æ­£
            const crystalModifier = 1 + crystalElement;
            
            // ç¨®æ—å½±éŸ¿ä¿®æ­£
            const raceModifier = 1 + raceEffect;

            // å¯µç‰©æ»¿æª”åŠ æˆ
            const petMaxStatsMultiplier = (casterType === 'pet' && isMaxStats) 
                ? (1 + maxStatsBonusTable[petGrade]) 
                : 1.0;
            
            // å¯µç‰©æ”¹é€ BOSSå¢å‚·
            const petReformBossMultiplier = (casterType === 'pet') 
                ? (1 + petReformBonusTable[petReformLevel][petGrade]) 
                : 1.0;
            
            // é‡ç¸è¢«å‹•
            const beastPassiveMultiplier = (casterType === 'pet' && isBeast) 
                ? (1 + beastPassiveBonusTable[petGrade]) 
                : 1.0;

            // æ´æ‚‰æŠ€èƒ½æ•ˆæœï¼ˆé™ä½æ‰€å—é­”æ³•å‚·å®³ï¼‰
            const insightMultiplier = 1 - (insightLevel / 100);
            
            // è¨ˆç®—åŸºç¤å€¼ï¼š[åŸºç¤å‚·å®³*æ°´æ™¶å±¬æ€§*éš¨æ©Ÿå€¼(85%~115%)]
            const baseWithCrystalMin = baseDamage * crystalModifier * 0.85;
            const baseWithCrystalAvg = baseDamage * crystalModifier * 1.0;
            const baseWithCrystalMax = baseDamage * crystalModifier * 1.15;
            
            // è¨ˆç®—ä¸‰ç¨®æƒ…æ³çš„å‚·å®³
            // 1. ä¸€èˆ¬é‡å¤–æ‰“æ€ªï¼šå¯µç‰©PVEåŠ æˆï¼Œç¨®æ—å½±éŸ¿æ­£å¸¸ï¼Œç„¡æ”¹é€ åŠ æˆ
            const pveMultiplierNormal = (casterType === 'pet' && isPVE) ? 1.2 : 1.0;
            const raceModifierNormal = 1 + raceEffect;
            const reformMultiplierNormal = 1.0; // ä¸€èˆ¬é‡å¤–ç„¡æ”¹é€ åŠ æˆ
            
            const dmgNormalMin = Math.floor(baseWithCrystalMin * spiritMultiplier * spiritDiffMultiplier * attackMultiplier * pveMultiplierNormal * raceModifierNormal * petMaxStatsMultiplier * reformMultiplierNormal * beastPassiveMultiplier * insightMultiplier);
            const dmgNormalAvg = Math.floor(baseWithCrystalAvg * spiritMultiplier * spiritDiffMultiplier * attackMultiplier * pveMultiplierNormal * raceModifierNormal * petMaxStatsMultiplier * reformMultiplierNormal * beastPassiveMultiplier * insightMultiplier);
            const dmgNormalMax = Math.floor(baseWithCrystalMax * spiritMultiplier * spiritDiffMultiplier * attackMultiplier * pveMultiplierNormal * raceModifierNormal * petMaxStatsMultiplier * reformMultiplierNormal * beastPassiveMultiplier * insightMultiplier);
            
            // 2. PKï¼šç„¡å¯µç‰©PVEåŠ æˆï¼Œç¨®æ—å½±éŸ¿æ¸›åŠï¼Œç„¡æ”¹é€ åŠ æˆ
            const pveMultiplierPK = 1.0; // PKç„¡PVEåŠ æˆ
            const raceModifierPK = 1 + (raceEffect / 2); // ç¨®æ—å½±éŸ¿æ¸›åŠ
            const reformMultiplierPK = 1.0; // PKç„¡æ”¹é€ åŠ æˆ
            
            const dmgPKMin = Math.floor(baseWithCrystalMin * spiritMultiplier * spiritDiffMultiplier * attackMultiplier * pveMultiplierPK * raceModifierPK * petMaxStatsMultiplier * reformMultiplierPK * beastPassiveMultiplier * insightMultiplier);
            const dmgPKAvg = Math.floor(baseWithCrystalAvg * spiritMultiplier * spiritDiffMultiplier * attackMultiplier * pveMultiplierPK * raceModifierPK * petMaxStatsMultiplier * reformMultiplierPK * beastPassiveMultiplier * insightMultiplier);
            const dmgPKMax = Math.floor(baseWithCrystalMax * spiritMultiplier * spiritDiffMultiplier * attackMultiplier * pveMultiplierPK * raceModifierPK * petMaxStatsMultiplier * reformMultiplierPK * beastPassiveMultiplier * insightMultiplier);
            
            // 3. BOSSæˆ°ï¼šå¯µç‰©PVEåŠ æˆï¼Œç¨®æ—å½±éŸ¿æ­£å¸¸ï¼Œæœ‰æ”¹é€ åŠ æˆ
            const pveMultiplierBoss = (casterType === 'pet' && isPVE) ? 1.2 : 1.0;
            const raceModifierBoss = 1 + raceEffect;
            const reformMultiplierBoss = petReformBossMultiplier; // BOSSæˆ°æœ‰æ”¹é€ åŠ æˆ
            
            const dmgBossMin = Math.floor(baseWithCrystalMin * spiritMultiplier * spiritDiffMultiplier * attackMultiplier * pveMultiplierBoss * raceModifierBoss * petMaxStatsMultiplier * reformMultiplierBoss * beastPassiveMultiplier * insightMultiplier);
            const dmgBossAvg = Math.floor(baseWithCrystalAvg * spiritMultiplier * spiritDiffMultiplier * attackMultiplier * pveMultiplierBoss * raceModifierBoss * petMaxStatsMultiplier * reformMultiplierBoss * beastPassiveMultiplier * insightMultiplier);
            const dmgBossMax = Math.floor(baseWithCrystalMax * spiritMultiplier * spiritDiffMultiplier * attackMultiplier * pveMultiplierBoss * raceModifierBoss * petMaxStatsMultiplier * reformMultiplierBoss * beastPassiveMultiplier * insightMultiplier);

            // é¡¯ç¤ºçµæœ
            document.getElementById('magicResultsSection').style.display = 'block';
            document.getElementById('magicBaseDamage').textContent = baseDamage;
            document.getElementById('magicSpiritMultiplier').textContent = (spiritMultiplier * 100).toFixed(1) + '%';
            document.getElementById('magicSpiritDiffMultiplier').textContent = (spiritDiffMultiplier * 100).toFixed(0) + '%';
            document.getElementById('magicAttackMultiplier').textContent = (attackMultiplier * 100).toFixed(0) + '%';
            
            const crystalLabel = document.getElementById('magicCrystalElement').options[document.getElementById('magicCrystalElement').selectedIndex].getAttribute('data-label');
            const raceLabel = document.getElementById('magicRaceEffect').options[document.getElementById('magicRaceEffect').selectedIndex].getAttribute('data-label');
            
            document.getElementById('magicModCrystal').innerHTML = `${crystalLabel} ${formatModifier(crystalElement)}`;
            document.getElementById('magicModRace').innerHTML = `${raceLabel} ${formatModifier(raceEffect)}`;
            
            // é¡¯ç¤ºå¯µç‰©ç›¸é—œå€ç‡
            const maxStatsItem = document.getElementById('magicModMaxStats');
            const reformItem = document.getElementById('magicModReform');
            const beastItem = document.getElementById('magicModBeast');
            
            if (casterType === 'pet') {
                maxStatsItem.style.display = 'flex';
                maxStatsItem.querySelector('.modifier-value').innerHTML = isMaxStats 
                    ? formatModifier(maxStatsBonusTable[petGrade]) 
                    : 'ç„¡';
                
                reformItem.style.display = 'flex';
                const reformBonus = petReformBonusTable[petReformLevel][petGrade];
                reformItem.querySelector('.modifier-value').innerHTML = reformBonus > 0 
                    ? formatModifier(reformBonus) 
                    : 'ç„¡';
                
                beastItem.style.display = 'flex';
                beastItem.querySelector('.modifier-value').innerHTML = isBeast 
                    ? formatModifier(beastPassiveBonusTable[petGrade]) 
                    : 'ç„¡';
            } else {
                maxStatsItem.style.display = 'none';
                reformItem.style.display = 'none';
                beastItem.style.display = 'none';
            }
            
            // é¡¯ç¤ºæ´æ‚‰æŠ€èƒ½æ•ˆæœ
            const insightItem = document.getElementById('magicModInsight');
            if (insightLevel > 0) {
                insightItem.style.display = 'flex';
                insightItem.querySelector('.modifier-value').textContent = `-${insightLevel}%`;
            } else {
                insightItem.style.display = 'flex';
                insightItem.querySelector('.modifier-value').textContent = 'ç„¡';
            }
            
            // é¡¯ç¤ºä¸‰ç¨®æƒ…æ³çš„å‚·å®³
            const typeName = isEx ? magicTypeNames[magicType] + ' EX' : magicTypeNames[magicType];
            
            // ä¸€èˆ¬é‡å¤–æ‰“æ€ª
            document.getElementById('magicTagTypeNormal').textContent = typeName;
            document.getElementById('magicDmgNormalMin').textContent = dmgNormalMin.toLocaleString();
            document.getElementById('magicDmgNormalAvg').textContent = dmgNormalAvg.toLocaleString();
            document.getElementById('magicDmgNormalMax').textContent = dmgNormalMax.toLocaleString();
            
            // PK
            document.getElementById('magicTagTypePK').textContent = typeName;
            document.getElementById('magicDmgPKMin').textContent = dmgPKMin.toLocaleString();
            document.getElementById('magicDmgPKAvg').textContent = dmgPKAvg.toLocaleString();
            document.getElementById('magicDmgPKMax').textContent = dmgPKMax.toLocaleString();
            
            // BOSSæˆ°
            document.getElementById('magicTagTypeBoss').textContent = typeName;
            document.getElementById('magicDmgBossMin').textContent = dmgBossMin.toLocaleString();
            document.getElementById('magicDmgBossAvg').textContent = dmgBossAvg.toLocaleString();
            document.getElementById('magicDmgBossMax').textContent = dmgBossMax.toLocaleString();

            // ç§»é™¤è‡ªå‹•æ»¾å‹•ï¼Œè®“ç”¨æˆ¶å¯ä»¥ç¹¼çºŒè¼¸å…¥
        }

        let compareList = [];
        let recordCounter = 1;
        let baseItemId = null; // åŸºæº–é …ç›® ID

        // å…¬å¼å€å¡Šåˆ‡æ›
        function toggleFormula() {
            const section = document.getElementById('formulaSection');
            const btn = document.querySelector('.formula-toggle');
            section.classList.toggle('show');
            btn.textContent = section.classList.contains('show') ? 'ğŸ“ éš±è—å…¬å¼' : 'ğŸ“ æŸ¥çœ‹å…¬å¼';
        }

        function toggleMagicFormula() {
            const section = document.getElementById('magicFormulaSection');
            const btn = event.target;
            section.classList.toggle('show');
            btn.textContent = section.classList.contains('show') ? 'ğŸ“ éš±è—å…¬å¼' : 'ğŸ“ æŸ¥çœ‹å…¬å¼';
        }

        function toggleMagicBaseDamageTable() {
            const table = document.getElementById('magicBaseDamageTable');
            const btn = event.target;
            table.classList.toggle('show');
            btn.textContent = table.classList.contains('show') ? 'ğŸ“Š éš±è—åŸºç¤å‚·å®³å€¼è¡¨' : 'ğŸ“Š æŸ¥çœ‹åŸºç¤å‚·å®³å€¼è¡¨';
        }

        function toggleMagicCoeffTable() {
            const table = document.getElementById('magicCoeffTable');
            const btn = event.target;
            const isShowing = table.classList.contains('show');
            table.classList.toggle('show');
            btn.textContent = !isShowing ? 'ğŸ“Š éš±è—é­”æ”»ä¿‚æ•¸è¡¨' : 'ğŸ“Š æŸ¥çœ‹é­”æ”»ä¿‚æ•¸è¡¨';
            
            // é¦–æ¬¡å±•é–‹æ™‚ç”Ÿæˆè¡¨æ ¼
            if (!isShowing) {
                // ä½¿ç”¨setTimeoutç¢ºä¿DOMæ›´æ–°å¾Œå†ç”Ÿæˆ
                setTimeout(() => {
                    generateMagicCoeffTable();
                }, 10);
            }
        }

        function generateMagicCoeffTable() {
            const tbody = document.getElementById('magicCoeffTableBody');
            if (!tbody) {
                console.error('æ‰¾ä¸åˆ° magicCoeffTableBody å…ƒç´ ');
                return;
            }
            
            // æ¯æ¬¡é‡æ–°ç”Ÿæˆï¼Œç¢ºä¿ä½¿ç”¨æœ€æ–°çš„æŸ¥æ‰¾è¡¨æ•¸æ“š
            
            // å¾æŸ¥æ‰¾è¡¨ä¸­ç²å–æ‰€æœ‰ä¿‚æ•¸å€¼ï¼ˆä½¿ç”¨ç­‰ç´š1çš„ä¿‚æ•¸ä½œç‚ºåŸºæº–ï¼‰
            if (!magicAttackLookupTable || !magicAttackLookupTable[1]) {
                tbody.innerHTML = '<tr><td colspan="12">æ•¸æ“šè¼‰å…¥ä¸­...</td></tr>';
                return;
            }
            
            const level1Table = magicAttackLookupTable[1];
            
            // ç²å–æ‰€æœ‰ä¿‚æ•¸éµä¸¦æ’åº
            // æ³¨æ„ï¼šåœ¨JavaScriptå°è±¡å­—é¢é‡ä¸­ï¼Œ1.0æœƒè®Šæˆ"1"ï¼Œ1.0125æœƒä¿æŒç‚º"1.0125"
            const coeffKeys = Object.keys(level1Table).sort((a, b) => {
                return parseFloat(a) - parseFloat(b);
            });
            
            if (coeffKeys.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12">ç„¡æ•¸æ“š</td></tr>';
                return;
            }
            
            let html = '';
            coeffKeys.forEach(coeffKey => {
                const coeff = parseFloat(coeffKey);
                html += '<tr>';
                // æ ¼å¼åŒ–ä¿‚æ•¸é¡¯ç¤º
                let coeffDisplay;
                if (coeff % 1 === 0) {
                    coeffDisplay = coeff.toString();
                } else {
                    // é¡¯ç¤º4ä½å°æ•¸
                    coeffDisplay = coeff.toFixed(4);
                }
                html += `<td>${coeffDisplay}</td>`;
                
                for (let level = 1; level <= 11; level++) {
                    const levelTable = magicAttackLookupTable[level];
                    let attackValue = '-';
                    
                    if (levelTable) {
                        // ç›´æ¥ä½¿ç”¨åŸå§‹éµæŸ¥æ‰¾
                        if (coeffKey in levelTable) {
                            attackValue = levelTable[coeffKey];
                        } else {
                            // å¦‚æœæ‰¾ä¸åˆ°ï¼Œå¯èƒ½æ˜¯å› ç‚º1.0è®Šæˆäº†"1"ï¼Œå˜—è©¦ç”¨æ•¸å­—æŸ¥æ‰¾
                            const numValue = coeff % 1 === 0 ? Math.floor(coeff) : coeff;
                            if (numValue in levelTable) {
                                attackValue = levelTable[numValue];
                            } else if (String(numValue) in levelTable) {
                                attackValue = levelTable[String(numValue)];
                            }
                        }
                    }
                    
                    html += `<td>${attackValue}</td>`;
                }
                html += '</tr>';
            });
            
            tbody.innerHTML = html;
        }

        // æŠ€èƒ½å€ç‡åŒæ­¥
        const skillRange = document.getElementById('skillMultiplierRange');
        const skillInput = document.getElementById('skillMultiplierInput');

        skillRange.addEventListener('input', function() {
            skillInput.value = this.value;
            calculate();
        });

        skillInput.addEventListener('input', function() {
            // è¼¸å…¥æ™‚ä¸å¼·åˆ¶é™åˆ¶ï¼Œè®“ä½¿ç”¨è€…å¯ä»¥è‡ªç”±è¼¸å…¥
            const val = parseInt(this.value);
            if (!isNaN(val) && val >= 20 && val <= 220) {
                skillRange.value = val;
                calculate();
            }
        });

        skillInput.addEventListener('blur', function() {
            // å¤±å»ç„¦é»æ™‚æ‰é©—è­‰ä¸¦ä¿®æ­£æ•¸å€¼
            let val = parseInt(this.value);
            if (isNaN(val) || val < 20) val = 20;
            if (val > 220) val = 220;
            this.value = val;
            skillRange.value = val;
            calculate();
        });

        skillInput.addEventListener('keydown', function(e) {
            // æŒ‰ Enter æ™‚é©—è­‰ä¸¦æ›´æ–°
            if (e.key === 'Enter') {
                this.blur();
            }
        });

        // å¿«æ·æŒ‰éˆ•è™•ç†å‡½æ•¸
        function setSkillMultiplier(value) {
            skillInput.value = value;
            skillRange.value = value;
            calculate();
        }

        function setQiankunMultiplier() {
            const level = parseInt(document.getElementById('qiankunLevel').value);
            if (level && level >= 1 && level <= 11) {
                setSkillMultiplier(100 + level * 10);
            }
        }

        function setHuixuanMultiplier() {
            const value = document.getElementById('huixuanLevel').value;
            if (!value) return;
            
            const huixuanTable = {
                '1-1': 56, '1-2': 70, '1-3': 84,
                '2-1': 60, '2-2': 75, '2-3': 90,
                '3-1': 64, '3-2': 80, '3-3': 96,
                '4-1': 68, '4-2': 85, '4-3': 102,
                '5-1': 72, '5-2': 90, '5-3': 108,
                '6-1': 76, '6-2': 95, '6-3': 114,
                '7-1': 80, '7-2': 100, '7-3': 120,
                '8-1': 84, '8-2': 105, '8-3': 126,
                '9-1': 88, '9-2': 110, '9-3': 132,
                '10-1': 92, '10-2': 115, '10-3': 138,
                '11-1': 96, '11-2': 120, '11-3': 144
            };
            
            if (huixuanTable[value]) {
                setSkillMultiplier(huixuanTable[value]);
            }
        }

        function setZhuiyueMultiplier() {
            const level = parseInt(document.getElementById('zhuiyueLevel').value);
            if (!level) return;
            
            const zhuiyueTable = {
                1: 70, 2: 75, 3: 80, 4: 85,  // Iå‹
                5: 75, 6: 78, 7: 81, 8: 85,  // Tå‹
                9: 75, 10: 80, 11: 95        // IIIå‹
            };
            
            let baseMultiplier = zhuiyueTable[level];
            if (!baseMultiplier) return;
            
            const isPVE = document.getElementById('zhuiyuePVE').checked;
            if (isPVE) {
                // PVEé¡å¤–å¢å‚·: (20 + æŠ€èƒ½ç­‰ç´š * 2)%ï¼Œ11ç­‰ç‚º45%ï¼Œç›´æ¥åŠ åˆ°åŸºç¤å€ç‡ä¸Š
                let pveBonus;
                if (level === 11) {
                    pveBonus = 45;
                } else {
                    pveBonus = 20 + level * 2;
                }
                baseMultiplier = baseMultiplier + pveBonus;
            }
            
            setSkillMultiplier(baseMultiplier);
        }

        function formatModifier(value, isPercent = true) {
            if (value === 0) return '<span class="modifier-neutral">+0%</span>';
            const sign = value > 0 ? '+' : '';
            const cls = value > 0 ? 'modifier-positive' : 'modifier-negative';
            const display = isPercent ? `${sign}${(value * 100).toFixed(0)}%` : `Ã—${value.toFixed(2)}`;
            return `<span class="${cls}">${display}</span>`;
        }

        function getSelectedLabel(selectId) {
            const sel = document.getElementById(selectId);
            return sel.options[sel.selectedIndex].getAttribute('data-label') || '';
        }

        function renderReformTable(petGrade, currentReform) {
            const tableEl = document.getElementById('reformTable');
            document.getElementById('currentGrade').textContent = gradeNames[petGrade];
            document.getElementById('currentGrade').className = `grade-${petGrade}`;

            let html = '';
            // Header
            for (let i = 0; i <= 5; i++) {
                html += `<div class="reform-table-cell header">${reformLabels[i]}</div>`;
            }
            // Values
            for (let i = 0; i <= 5; i++) {
                const bonus = petReformBonusTable[i][petGrade];
                const isActive = i === currentReform;
                const displayVal = bonus === 0 ? '-' : `+${(bonus * 100).toFixed(0)}%`;
                html += `<div class="reform-table-cell${isActive ? ' active' : ''}">${displayVal}</div>`;
            }
            tableEl.innerHTML = html;
        }

        function getCurrentParams() {
            const attack = parseFloat(document.getElementById('attack').value) || 0;
            const defense = parseFloat(document.getElementById('defense').value) || 0;
            const attackerLevel = parseFloat(document.getElementById('attackerLevel').value) || 1;
            const defenderLevel = parseFloat(document.getElementById('defenderLevel').value) || 1;
            const weaponSharpness = parseFloat(document.getElementById('weaponSharpness').value);
            const crystalElement = parseFloat(document.getElementById('crystalElement').value);
            const raceEffect = parseFloat(document.getElementById('raceEffect').value);
            const skillMultiplier = parseFloat(skillInput.value) / 100;
            const isMaxStats = document.getElementById('maxStats').checked;
            const petReformLevel = parseInt(document.getElementById('petReform').value);
            const isBeast = document.getElementById('beastPassive').checked;
            const petGrade = document.getElementById('petGrade').value;

            const crystalLabel = getSelectedLabel('crystalElement');
            const raceLabel = getSelectedLabel('raceEffect');

            const attackEffect = attack <= 240 ? attack : 240 + 0.3 * (attack - 240);
            const defenseEffect = defense <= 240 ? defense : 240 + 0.3 * (defense - 240);
            const baseDamage = Math.pow(attackEffect, 2) * 3 / (attackEffect + defenseEffect * 3);
            const critCorrection = defense * attackerLevel / (defenderLevel * 2);
            const weaponModifier = 1 + weaponSharpness;
            const crystalModifier = 1 + crystalElement;
            const raceModifier = 1 + raceEffect;

            const maxStatsBonus = isMaxStats ? maxStatsBonusTable[petGrade] : 0;
            const petReformBonus = petReformBonusTable[petReformLevel][petGrade];
            const beastBonus = isBeast ? beastPassiveBonusTable[petGrade] : 0;

            return {
                attack, defense, attackerLevel, defenderLevel,
                weaponSharpness, crystalElement, raceEffect,
                crystalLabel, raceLabel,
                skillMultiplier, isMaxStats, petReformLevel, isBeast, petGrade,
                attackEffect, defenseEffect, baseDamage, critCorrection,
                weaponModifier, crystalModifier, raceModifier,
                maxStatsBonus, petReformBonus, beastBonus
            };
        }

        function calculateDamage(params, withCrit, withBoss, skillMult = null) {
            const { baseDamage, critCorrection, weaponModifier, crystalModifier, raceModifier, 
                    skillMultiplier, maxStatsBonus, petReformBonus, beastBonus } = params;

            const actualSkillMult = skillMult !== null ? skillMult : skillMultiplier;
            const maxStatsMult = 1 + maxStatsBonus;
            const beastMult = 1 + beastBonus;
            const reformMult = withBoss ? (1 + petReformBonus) : 1;
            const crit = withCrit ? critCorrection : 0;

            const baseCalc = baseDamage * weaponModifier * crystalModifier;
            
            const dmgMin = (baseCalc * 0.90 + crit) * raceModifier * actualSkillMult * maxStatsMult * reformMult * beastMult;
            const dmgAvg = (baseCalc * 1.00 + crit) * raceModifier * actualSkillMult * maxStatsMult * reformMult * beastMult;
            const dmgMax = (baseCalc * 1.10 + crit) * raceModifier * actualSkillMult * maxStatsMult * reformMult * beastMult;

            return {
                min: Math.floor(dmgMin),
                avg: Math.floor(dmgAvg),
                max: Math.floor(dmgMax)
            };
        }

        function calculate() {
            const params = getCurrentParams();

            // åŸºç¤æ•¸å€¼
            document.getElementById('resultAttackEffect').textContent = params.attackEffect.toFixed(2);
            document.getElementById('resultDefenseEffect').textContent = params.defenseEffect.toFixed(2);
            document.getElementById('resultBaseDamage').textContent = params.baseDamage.toFixed(2);
            document.getElementById('resultCritCorrection').textContent = params.critCorrection.toFixed(2);

            // ä¿®æ­£å€¼
            document.getElementById('modCrystal').innerHTML = 
                `${params.crystalLabel} ${formatModifier(params.crystalElement)}`;
            document.getElementById('modRace').innerHTML = 
                `${params.raceLabel} ${formatModifier(params.raceEffect)}`;
            document.getElementById('modWeapon').innerHTML = formatModifier(params.weaponSharpness);
            document.getElementById('modSkill').innerHTML = 
                `<span class="modifier-positive">Ã—${params.skillMultiplier.toFixed(2)}</span>`;
            document.getElementById('modMaxStats').innerHTML = 
                params.isMaxStats ? formatModifier(params.maxStatsBonus) : '<span class="modifier-neutral">ç„¡</span>';
            document.getElementById('modBeast').innerHTML = 
                params.isBeast ? formatModifier(params.beastBonus) : '<span class="modifier-neutral">ç„¡</span>';

            // æ”¹é€ å€ç‡è¡¨
            renderReformTable(params.petGrade, params.petReformLevel);

            // æ›´æ–°æŠ€èƒ½%æ¨™ç±¤
            const skillPercent = Math.round(params.skillMultiplier * 100);
            document.getElementById('tagSkill1').textContent = `æŠ€èƒ½${skillPercent}%`;
            document.getElementById('tagSkill2').textContent = `æŠ€èƒ½${skillPercent}%`;
            document.getElementById('tagSkill3').textContent = `æŠ€èƒ½${skillPercent}%`;
            document.getElementById('tagSkill4').textContent = `æŠ€èƒ½${skillPercent}%`;

            // å…«ç¨®å‚·å®³æƒ…æ³
            // ä¸€èˆ¬å‚·å®³ï¼ˆç„¡BOSSå¢å‚·ï¼‰
            const dmgNA_NoCrit = calculateDamage(params, false, false, 1.0);    // æ™®æ”»100%, ç„¡å¿…æ®º
            const dmgSkill_NoCrit = calculateDamage(params, false, false);      // æŠ€èƒ½%, ç„¡å¿…æ®º
            const dmgNA_Crit = calculateDamage(params, true, false, 1.0);       // æ™®æ”»100%, æœ‰å¿…æ®º
            const dmgSkill_Crit = calculateDamage(params, true, false);         // æŠ€èƒ½%, æœ‰å¿…æ®º

            // BOSSæˆ°å‚·å®³ï¼ˆå«æ”¹é€ å¢å‚·ï¼‰
            const dmgNA_Boss = calculateDamage(params, false, true, 1.0);       // æ™®æ”»100%, ç„¡å¿…æ®º, BOSS
            const dmgSkill_Boss = calculateDamage(params, false, true);         // æŠ€èƒ½%, ç„¡å¿…æ®º, BOSS
            const dmgNA_BossCrit = calculateDamage(params, true, true, 1.0);    // æ™®æ”»100%, æœ‰å¿…æ®º, BOSS
            const dmgSkill_BossCrit = calculateDamage(params, true, true);      // æŠ€èƒ½%, æœ‰å¿…æ®º, BOSS

            // æ›´æ–°ä¸€èˆ¬å‚·å®³å€
            document.getElementById('dmgNA_NoCrit_Min').textContent = dmgNA_NoCrit.min.toLocaleString();
            document.getElementById('dmgNA_NoCrit_Avg').textContent = dmgNA_NoCrit.avg.toLocaleString();
            document.getElementById('dmgNA_NoCrit_Max').textContent = dmgNA_NoCrit.max.toLocaleString();

            document.getElementById('dmgSkill_NoCrit_Min').textContent = dmgSkill_NoCrit.min.toLocaleString();
            document.getElementById('dmgSkill_NoCrit_Avg').textContent = dmgSkill_NoCrit.avg.toLocaleString();
            document.getElementById('dmgSkill_NoCrit_Max').textContent = dmgSkill_NoCrit.max.toLocaleString();

            document.getElementById('dmgNA_Crit_Min').textContent = dmgNA_Crit.min.toLocaleString();
            document.getElementById('dmgNA_Crit_Avg').textContent = dmgNA_Crit.avg.toLocaleString();
            document.getElementById('dmgNA_Crit_Max').textContent = dmgNA_Crit.max.toLocaleString();

            document.getElementById('dmgSkill_Crit_Min').textContent = dmgSkill_Crit.min.toLocaleString();
            document.getElementById('dmgSkill_Crit_Avg').textContent = dmgSkill_Crit.avg.toLocaleString();
            document.getElementById('dmgSkill_Crit_Max').textContent = dmgSkill_Crit.max.toLocaleString();

            // æ›´æ–°BOSSå‚·å®³å€
            document.getElementById('dmgNA_Boss_Min').textContent = dmgNA_Boss.min.toLocaleString();
            document.getElementById('dmgNA_Boss_Avg').textContent = dmgNA_Boss.avg.toLocaleString();
            document.getElementById('dmgNA_Boss_Max').textContent = dmgNA_Boss.max.toLocaleString();

            document.getElementById('dmgSkill_Boss_Min').textContent = dmgSkill_Boss.min.toLocaleString();
            document.getElementById('dmgSkill_Boss_Avg').textContent = dmgSkill_Boss.avg.toLocaleString();
            document.getElementById('dmgSkill_Boss_Max').textContent = dmgSkill_Boss.max.toLocaleString();

            document.getElementById('dmgNA_BossCrit_Min').textContent = dmgNA_BossCrit.min.toLocaleString();
            document.getElementById('dmgNA_BossCrit_Avg').textContent = dmgNA_BossCrit.avg.toLocaleString();
            document.getElementById('dmgNA_BossCrit_Max').textContent = dmgNA_BossCrit.max.toLocaleString();

            document.getElementById('dmgSkill_BossCrit_Min').textContent = dmgSkill_BossCrit.min.toLocaleString();
            document.getElementById('dmgSkill_BossCrit_Avg').textContent = dmgSkill_BossCrit.avg.toLocaleString();
            document.getElementById('dmgSkill_BossCrit_Max').textContent = dmgSkill_BossCrit.max.toLocaleString();
        }

        function addToCompareList() {
            const params = getCurrentParams();
            let recordName = document.getElementById('recordName').value.trim();
            
            if (!recordName) {
                recordName = `è¨˜éŒ„ ${recordCounter++}`;
            }

            // æ™®æ”»ç‰ˆæœ¬ (100%)
            const dmgNA_NoCrit = calculateDamage(params, false, false, 1.0);
            const dmgNA_Crit = calculateDamage(params, true, false, 1.0);
            const dmgNA_Boss = calculateDamage(params, false, true, 1.0);
            const dmgNA_BossCrit = calculateDamage(params, true, true, 1.0);
            
            // æŠ€èƒ½ç‰ˆæœ¬
            const dmgSkill_NoCrit = calculateDamage(params, false, false);
            const dmgSkill_Crit = calculateDamage(params, true, false);
            const dmgSkill_Boss = calculateDamage(params, false, true);
            const dmgSkill_BossCrit = calculateDamage(params, true, true);

            compareList.push({
                id: Date.now(),
                name: recordName,
                attack: params.attack,
                defense: params.defense,
                hasWeapon: params.weaponSharpness > 0,
                petGrade: params.petGrade,
                isMaxStats: params.isMaxStats,
                isBeast: params.isBeast,
                petReformLevel: params.petReformLevel,
                crystalLabel: params.crystalLabel,
                raceLabel: params.raceLabel,
                skillPercent: Math.round(params.skillMultiplier * 100),
                maxStatsPercent: params.isMaxStats ? Math.round(params.maxStatsBonus * 100) : 0,
                reformPercent: Math.round(params.petReformBonus * 100),
                beastPercent: params.isBeast ? Math.round(params.beastBonus * 100) : 0,
                // æ™®æ”»ç‰ˆæœ¬
                dmgNA_NoCrit: dmgNA_NoCrit.avg,
                dmgNA_Crit: dmgNA_Crit.avg,
                dmgNA_Boss: dmgNA_Boss.avg,
                dmgNA_BossCrit: dmgNA_BossCrit.avg,
                // æŠ€èƒ½ç‰ˆæœ¬
                dmgSkill_NoCrit: dmgSkill_NoCrit.avg,
                dmgSkill_Crit: dmgSkill_Crit.avg,
                dmgSkill_Boss: dmgSkill_Boss.avg,
                dmgSkill_BossCrit: dmgSkill_BossCrit.avg
            });

            document.getElementById('recordName').value = '';
            renderCompareList();
        }

        function renderCompareList() {
            const emptyEl = document.getElementById('compareListEmpty');
            const scrollEl = document.getElementById('compareListScroll');
            const bodyEl = document.getElementById('compareListBody');

            if (compareList.length === 0) {
                emptyEl.style.display = 'block';
                scrollEl.style.display = 'none';
                baseItemId = null;
                return;
            }

            emptyEl.style.display = 'none';
            scrollEl.style.display = 'block';

            // å¦‚æœæ²’æœ‰è¨­å®šåŸºæº–ï¼Œæˆ–åŸºæº–é …ç›®å·²è¢«åˆªé™¤ï¼Œå‰‡ä½¿ç”¨ç¬¬ä¸€ç­†
            let baseItem = compareList.find(item => item.id === baseItemId);
            if (!baseItem) {
                baseItemId = compareList[0].id;
                baseItem = compareList[0];
            }

            let html = '';
            compareList.forEach((item, index) => {
                const isBase = item.id === baseItemId;
                const isNew = index === compareList.length - 1;

                const getDiff = (current, base) => {
                    if (isBase || base === 0) return '';
                    const diff = ((current - base) / base * 100).toFixed(1);
                    if (diff > 0) return `<br><span class="list-diff-positive">+${diff}%</span>`;
                    if (diff < 0) return `<br><span class="list-diff-negative">${diff}%</span>`;
                    return '';
                };

                const rowClass = isBase ? 'base-row' : (isNew ? 'highlight-row' : '');
                const baseLabel = isBase ? '<span class="base-indicator">åŸºæº–</span>' : '';
                const btnClass = isBase ? 'btn-set-base active' : 'btn-set-base';
                const btnText = isBase ? 'âœ“ åŸºæº–' : 'è¨­ç‚ºåŸºæº–';

                const maxStatsDisplay = item.isMaxStats ? `+${item.maxStatsPercent}%` : '-';
                const beastDisplay = item.isBeast ? `+${item.beastPercent}%` : '-';
                const reformDisplay = item.petReformLevel > 0 ? `${reformLabels[item.petReformLevel]} +${item.reformPercent}%` : 'æœªæ”¹';
                const weaponDisplay = item.hasWeapon ? 'æœ‰' : 'ç„¡';

                const shortReform = item.petReformLevel > 0 ? `${item.petReformLevel}æ”¹ +${item.reformPercent}%` : '-';

                html += `
                    <tr class="${rowClass}" draggable="true" data-id="${item.id}" data-index="${index}">
                        <td class="item-name" title="${item.name}">
                            <span class="name-display" id="name-${item.id}" onclick="editItemName(${item.id}, event)">${item.name}</span>
                            <input type="text" class="name-input" id="name-input-${item.id}" value="${item.name}" 
                                   style="display: none;" 
                                   onblur="saveItemName(${item.id})" 
                                   onkeydown="handleNameKeydown(${item.id}, event)">
                            ${baseLabel}
                        </td>
                        <td>${item.attack}/${item.defense}</td>
                        <td><span class="status-badge ${item.hasWeapon ? 'status-yes' : 'status-no'}">${weaponDisplay}</span></td>
                        <td>${item.crystalLabel}</td>
                        <td>${item.raceLabel}</td>
                        <td class="grade-${item.petGrade}">${gradeNames[item.petGrade]}</td>
                        <td><span class="status-badge ${item.isMaxStats ? 'status-yes' : 'status-no'}">${maxStatsDisplay}</span></td>
                        <td><span class="status-badge ${item.isBeast ? 'status-yes' : 'status-no'}">${beastDisplay}</span></td>
                        <td><span class="reform-badge reform-${item.petReformLevel}">${shortReform}</span></td>
                        <td><span class="skill-badge">${item.skillPercent}%</span></td>
                        <td class="dmg-cell">${item.dmgNA_NoCrit.toLocaleString()}${getDiff(item.dmgNA_NoCrit, baseItem.dmgNA_NoCrit)}</td>
                        <td class="dmg-cell">${item.dmgSkill_NoCrit.toLocaleString()}${getDiff(item.dmgSkill_NoCrit, baseItem.dmgSkill_NoCrit)}</td>
                        <td class="dmg-cell">${item.dmgNA_Crit.toLocaleString()}${getDiff(item.dmgNA_Crit, baseItem.dmgNA_Crit)}</td>
                        <td class="dmg-cell">${item.dmgSkill_Crit.toLocaleString()}${getDiff(item.dmgSkill_Crit, baseItem.dmgSkill_Crit)}</td>
                        <td class="dmg-cell">${item.dmgNA_Boss.toLocaleString()}${getDiff(item.dmgNA_Boss, baseItem.dmgNA_Boss)}</td>
                        <td class="dmg-cell">${item.dmgSkill_Boss.toLocaleString()}${getDiff(item.dmgSkill_Boss, baseItem.dmgSkill_Boss)}</td>
                        <td class="dmg-cell">${item.dmgNA_BossCrit.toLocaleString()}${getDiff(item.dmgNA_BossCrit, baseItem.dmgNA_BossCrit)}</td>
                        <td class="dmg-cell">${item.dmgSkill_BossCrit.toLocaleString()}${getDiff(item.dmgSkill_BossCrit, baseItem.dmgSkill_BossCrit)}</td>
                        <td>
                            <button class="btn-move" onclick="moveUp(${index})" ${index === 0 ? 'disabled' : ''} title="ä¸Šç§»">â–²</button>
                            <button class="btn-move" onclick="moveDown(${index})" ${index === compareList.length - 1 ? 'disabled' : ''} title="ä¸‹ç§»">â–¼</button>
                            <button class="${btnClass}" onclick="setAsBase(${item.id})">${btnText}</button>
                            <button class="btn-delete-item" onclick="removeFromList(${item.id})">âœ•</button>
                        </td>
                    </tr>
                `;
            });

            bodyEl.innerHTML = html;
            
            // æ·»åŠ æ‹–æ›³äº‹ä»¶ç›£è½å™¨
            const rows = bodyEl.querySelectorAll('tr[draggable="true"]');
            rows.forEach(row => {
                row.addEventListener('dragstart', handleDragStart);
                row.addEventListener('dragover', handleDragOver);
                row.addEventListener('drop', handleDrop);
                row.addEventListener('dragend', handleDragEnd);
            });
        }

        // åç¨±ç·¨è¼¯ç›¸é—œå‡½æ•¸
        let isDragging = false;
        
        function editItemName(id, event) {
            if (isDragging) return;
            event.stopPropagation();
            const displayEl = document.getElementById(`name-${id}`);
            const inputEl = document.getElementById(`name-input-${id}`);
            if (displayEl && inputEl) {
                displayEl.style.display = 'none';
                inputEl.style.display = 'block';
                inputEl.focus();
                inputEl.select();
            }
        }

        function saveItemName(id) {
            const displayEl = document.getElementById(`name-${id}`);
            const inputEl = document.getElementById(`name-input-${id}`);
            if (displayEl && inputEl) {
                const newName = inputEl.value.trim();
                if (newName) {
                    const item = compareList.find(item => item.id === id);
                    if (item) {
                        item.name = newName;
                        displayEl.textContent = newName;
                        inputEl.setAttribute('value', newName);
                    }
                } else {
                    inputEl.value = displayEl.textContent;
                }
                displayEl.style.display = '';
                inputEl.style.display = 'none';
            }
        }

        function handleNameKeydown(id, event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                saveItemName(id);
            } else if (event.key === 'Escape') {
                event.preventDefault();
                const displayEl = document.getElementById(`name-${id}`);
                const inputEl = document.getElementById(`name-input-${id}`);
                if (displayEl && inputEl) {
                    inputEl.value = displayEl.textContent;
                    displayEl.style.display = '';
                    inputEl.style.display = 'none';
                }
            }
        }

        // æ‹–æ›³æ’åºç›¸é—œå‡½æ•¸
        let draggedElement = null;

        function handleDragStart(e) {
            draggedElement = this;
            isDragging = true;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            
            const rows = document.querySelectorAll('#compareListBody tr');
            rows.forEach(row => {
                if (row !== draggedElement) {
                    row.classList.remove('drag-over');
                }
            });
            
            const afterElement = getDragAfterElement(e.clientY);
            if (afterElement && afterElement !== draggedElement) {
                afterElement.classList.add('drag-over');
            }
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            e.preventDefault();
            
            const rows = document.querySelectorAll('#compareListBody tr');
            rows.forEach(row => {
                row.classList.remove('drag-over');
            });
            
            if (draggedElement) {
                const draggedId = parseInt(draggedElement.getAttribute('data-id'));
                const draggedIndex = compareList.findIndex(item => item.id === draggedId);
                
                if (draggedIndex === -1) {
                    draggedElement.classList.remove('dragging');
                    return false;
                }
                
                const afterElement = getDragAfterElement(e.clientY);
                let targetIndex;
                
                if (afterElement == null) {
                    // æ‹–åˆ°æœ€å¾Œ
                    targetIndex = compareList.length;
                } else {
                    const targetId = parseInt(afterElement.getAttribute('data-id'));
                    targetIndex = compareList.findIndex(item => item.id === targetId);
                }
                
                // é‡æ–°æ’åº compareList
                if (targetIndex !== draggedIndex) {
                    const draggedItem = compareList[draggedIndex];
                    compareList.splice(draggedIndex, 1);
                    
                    // å¦‚æœç›®æ¨™ç´¢å¼•åœ¨æ‹–æ›³å…ƒç´ ä¹‹å¾Œï¼Œéœ€è¦æ¸›1
                    if (targetIndex > draggedIndex) {
                        targetIndex--;
                    }
                    
                    compareList.splice(targetIndex, 0, draggedItem);
                    renderCompareList();
                }
            }
            
            return false;
        }

        function handleDragEnd(e) {
            const rows = document.querySelectorAll('#compareListBody tr');
            rows.forEach(row => {
                row.classList.remove('dragging', 'drag-over');
            });
            draggedElement = null;
            isDragging = false;
        }

        function getDragAfterElement(y) {
            const draggableElements = [...document.querySelectorAll('#compareListBody tr:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function setAsBase(id) {
            baseItemId = id;
            renderCompareList();
        }

        function removeFromList(id) {
            compareList = compareList.filter(item => item.id !== id);
            renderCompareList();
        }

        function moveUp(index) {
            if (index <= 0) return;
            const temp = compareList[index];
            compareList[index] = compareList[index - 1];
            compareList[index - 1] = temp;
            renderCompareList();
        }

        function moveDown(index) {
            if (index >= compareList.length - 1) return;
            const temp = compareList[index];
            compareList[index] = compareList[index + 1];
            compareList[index + 1] = temp;
            renderCompareList();
        }

        function clearCompareList() {
            if (compareList.length === 0) return;
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ¯”è¼ƒè¨˜éŒ„å—ï¼Ÿ')) {
                compareList = [];
                recordCounter = 1;
                renderCompareList();
            }
        }

        window.onload = function() { 
            calculate(); 
            updateMagicOptions(); // åˆå§‹åŒ–é­”æ³•é¸é …
        };

        document.querySelectorAll('input:not(#recordName):not(#skillMultiplierInput):not(#skillMultiplierRange):not(#magicCasterSpirit):not(#magicTargetSpirit):not(#magicAttack), select:not(#magicCasterType):not(#magicType):not(#magicLevel):not(#magicCrystalElement):not(#magicRaceEffect)').forEach(el => {
            el.addEventListener('change', calculate);
            el.addEventListener('input', calculate);
        });

        // é­”æ³•å‚·å®³è¨ˆç®—çš„äº‹ä»¶ç›£è½å™¨ï¼ˆåƒ…æ›´æ–°é¸é …ï¼Œä¸è‡ªå‹•è¨ˆç®—ï¼‰
        document.getElementById('magicCasterType').addEventListener('change', updateMagicOptions);
        document.getElementById('magicType').addEventListener('change', updateMagicLevelOptions);
        document.getElementById('magicPVE').addEventListener('change', function() {
            // PVEé–‹é—œè®ŠåŒ–æ™‚ä¸è‡ªå‹•è¨ˆç®—ï¼Œåªæ›´æ–°é¡¯ç¤º
        });
    </script>
</body>
</html>
