<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜Ÿè© é­”åŠ› - å¸‚å ´æŸ¥åƒ¹å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #f5f0e8;
            --bg-card: #fffbf5;
            --bg-card-hover: #fff8ec;
            --border: #e0d5c5;
            --text-primary: #4a3f35;
            --text-secondary: #8b7355;
            --accent-gold: #d4a024;
            --accent-blue: #5b8cb8;
            --accent-green: #5a9a5a;
            --accent-red: #c75050;
            --accent-purple: #9068b0;
            --server-1: #d35d5d;
            --server-2: #5a9a5a;
            --server-3: #5b8cb8;
            --shadow: 0 4px 16px rgba(74,63,53,0.12);
            --radius: 8px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Noto Sans TC', -apple-system, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            font-size: 16px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(135deg, #b8860b, #8b4513);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header .badge {
            background: var(--accent-purple);
            color: #fff;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Search Panel */
        .search-panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
        }

        .search-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: flex-end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group label {
            font-size: 0.95rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .form-group.grow {
            flex: 1;
            min-width: 200px;
        }

        .exchange-rate-group input {
            width: 100px;
        }

        input[type="text"], input[type="number"], select {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 10px 14px;
            color: var(--text-primary);
            font-size: 1.05rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.2);
        }

        button {
            background: linear-gradient(135deg, #b48a61, #8b6b4a);
            border: none;
            border-radius: var(--radius);
            padding: 12px 24px;
            color: #fff;
            font-size: 1.05rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139,107,74,0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        button.secondary {
            background: #fff;
            border: 2px solid #b48a61;
            color: #6b4c2a;
        }

        button.secondary:hover {
            background: #f5e6d3;
            border-color: #8b6b4a;
            box-shadow: none;
        }

        /* Quick Tags */
        .quick-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .quick-tag {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .quick-tag:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        .quick-tag .remove {
            color: var(--accent-red);
            font-weight: bold;
            opacity: 0.6;
        }

        .quick-tag .remove:hover {
            opacity: 1;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            text-align: center;
        }

        .stat-card .label {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .stat-card .value {
            font-size: 1.2rem;
            font-weight: 700;
            line-height: 1.4;
        }

        .stat-card .value.gold { color: var(--accent-gold); }
        .stat-card .value.green { color: var(--accent-green); }
        .stat-card .value.blue { color: var(--accent-blue); }
        .stat-card .value.red { color: var(--accent-red); }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 16px;
            background: var(--bg-card);
            padding: 4px;
            border-radius: var(--radius);
            width: fit-content;
        }

        .tab {
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .tab:hover {
            color: var(--text-primary);
        }

        .tab.active {
            background: #b48a61;
            color: #fff;
        }

        /* Tables */
        .table-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .table-scroll {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th {
            background: var(--bg-dark);
            padding: 14px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            color: var(--accent-blue);
        }

        th .sort-icon {
            margin-left: 4px;
            opacity: 0.5;
        }

        th .sort-icon.active {
            opacity: 1;
            color: var(--accent-gold);
        }

        td {
            padding: 14px 12px;
            border-bottom: 1px solid var(--border);
            font-size: 1rem;
        }

        /* å›ºå®šç¬¬ä¸€æ¬„ï¼ˆç‰©å“åç¨±ï¼‰ */
        th:first-child,
        td:first-child {
            position: sticky;
            left: 0;
            background: var(--bg-card);
            z-index: 2;
            border-right: 2px solid var(--border);
        }

        th:first-child {
            background: var(--bg-dark);
            z-index: 3;
        }

        tr:hover td {
            background: var(--bg-card-hover);
        }

        tr:hover td:first-child {
            background: var(--bg-card-hover);
        }

        tr:last-child td {
            border-bottom: none;
        }

        /* Server Badge */
        .server-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-right: 6px;
        }

        .server-badge.s1 { background: var(--server-1); color: #fff; }
        .server-badge.s2 { background: var(--server-2); color: #fff; }
        .server-badge.s3 { background: var(--server-3); color: #fff; }

        /* æ”¹é€ åœ–ç­‰ç´šæ¨™ç±¤ */
        .grade-normal {
            background: #D2691E;
            color: #fff;
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-left: 8px;
            display: inline-block;
            vertical-align: middle;
        }
        .grade-silver {
            background: #808080;
            color: #fff;
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-left: 8px;
            display: inline-block;
            vertical-align: middle;
        }
        .grade-gold {
            background: #DAA520;
            color: #fff;
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-left: 8px;
            display: inline-block;
            vertical-align: middle;
        }

        /* é‡ä¾†çš„ç¨®å­ BP æ¨™ç±¤ */
        .bp-plus {
            background: #27ae60;
            color: #fff;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 4px;
        }
        .bp-minus {
            background: #e74c3c;
            color: #fff;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 4px;
        }

        /* å¯µç‰©æ¨™ç±¤ */
        .pet-lv {
            background: #3498db;
            color: #fff;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 6px;
        }
        
        .pet-trans {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: #fff;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 4px;
        }
        
        .pet-slot {
            background: #27ae60;
            color: #fff;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 4px;
        }

        /* Price Display */
        .price {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
        }

        .price.coin { color: var(--accent-gold); }
        .price.crystal { color: var(--accent-purple); }

        .converted {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-left: 8px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .loading .spinner {
            display: inline-block;
            width: 32px;
            height: 32px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Inline Chart Container (åœ¨è¡¨æ ¼è¡Œå…§) */
        .inline-chart-container {
            background: var(--bg-card);
            padding: 16px;
            border-top: 2px solid var(--border);
        }

        .inline-chart-container .chart-title {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .inline-chart-wrapper {
            position: relative;
            height: 250px;
        }

        .chart-row td {
            padding: 0 !important;
        }

        /* History Summary */
        .history-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
        }

        .summary-card h3 {
            font-size: 1rem;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .summary-row:last-child {
            border-bottom: none;
        }

        .summary-row .label {
            color: var(--text-secondary);
        }

        .summary-row .value {
            font-weight: 600;
        }

        /* Responsive - å¹³æ¿ */
        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }

            .header {
                flex-wrap: wrap;
            }

            .header h1 {
                font-size: 1.25rem;
            }

            .header a {
                font-size: 0.75rem;
                margin-left: 0;
                width: 100%;
                margin-top: 8px;
            }

            .search-row {
                flex-direction: column;
            }

            .form-group {
                width: 100%;
            }

            .form-group.grow {
                width: 100%;
            }

            .search-row button {
                width: 100%;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .tabs {
                width: 100%;
            }

            .tab {
                flex: 1;
                text-align: center;
                padding: 10px 12px;
                font-size: 0.9rem;
            }

            /* è¡¨æ ¼æ°´å¹³æ»¾å‹• */
            .table-container {
                overflow: hidden;
            }

            .table-scroll {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            table {
                min-width: 800px;
            }
        }

        /* Responsive - æ‰‹æ©Ÿ */
        @media (max-width: 480px) {
            .container {
                padding: 8px;
            }

            .header h1 {
                font-size: 1.1rem;
            }

            .header .badge {
                font-size: 0.65rem;
                padding: 3px 8px;
            }

            .search-panel {
                padding: 12px;
            }

            .form-group label {
                font-size: 0.85rem;
            }

            input[type="text"], input[type="number"], select {
                padding: 10px 12px;
                font-size: 1rem;
            }

            button {
                padding: 12px 16px;
                font-size: 1rem;
            }

            .quick-tags {
                gap: 6px;
            }

            .quick-tag {
                padding: 6px 12px;
                font-size: 0.9rem;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            .stat-card {
                padding: 12px 8px;
            }

            .stat-card .label {
                font-size: 0.95rem;
                font-weight: 600;
            }

            .stat-card .value {
                font-size: 1.0rem;
                line-height: 1.3;
            }

            .tabs {
                padding: 3px;
            }

            .tab {
                padding: 8px 10px;
                font-size: 0.85rem;
            }

            td, th {
                padding: 10px 8px;
                font-size: 0.9rem;
            }

            .price {
                font-size: 0.9rem;
            }

            .converted {
                display: block;
                margin-left: 0;
                margin-top: 2px;
                font-size: 0.8rem;
            }

            .grade-normal, .grade-silver, .grade-gold {
                font-size: 0.7rem;
                padding: 1px 6px;
                margin-left: 4px;
            }

            .bp-plus, .bp-minus {
                font-size: 0.65rem;
                padding: 1px 4px;
                margin-left: 2px;
            }

            .server-badge {
                font-size: 0.65rem;
                padding: 1px 5px;
            }

            .chart-container {
                padding: 12px;
            }

            .chart-wrapper {
                height: 250px;
            }

            .empty-state {
                padding: 40px 16px;
            }

            .empty-state .icon {
                font-size: 2.5rem;
            }
        }

        /* Tooltip */
        .tooltip {
            position: relative;
        }

        .tooltip::after {
            content: attr(data-tip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-dark);
            border: 1px solid var(--border);
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .tooltip:hover::after {
            opacity: 1;
        }

        /* Highlight row */
        .highlight {
            animation: highlight 1.5s ease-out;
        }

        @keyframes highlight {
            0% { background: rgba(180, 138, 97, 0.3); }
            100% { background: transparent; }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            50% { transform: scale(1.02); box-shadow: 0 0 15px 5px rgba(231, 76, 60, 0.4); }
        }
    </style>
</head>
<body>

<div class="container">
    <!-- Header -->
    <div class="header">
        <h1>â­ æ˜Ÿè© é­”åŠ› å¸‚å ´æŸ¥åƒ¹å™¨</h1>
        <span class="badge">v2.0</span>
        <a href="https://member.starcg.net/market.php" target="_blank" 
           style="margin-left:auto; color:var(--text-secondary); font-size:0.9rem; text-decoration:none;">
            ğŸ“‹ å®˜æ–¹å¸‚å ´
        </a>
    </div>

    <!-- Search Panel -->
    <div class="search-panel">
        <div class="search-row">
            <div class="form-group grow">
                <label>ğŸ” æœå°‹ç‰©å“/å¯µç‰©åç¨±</label>
                <input type="text" id="searchInput" placeholder="è¼¸å…¥åç¨±é—œéµå­—...">
            </div>
            <div class="form-group">
                <label>ğŸ’° å¹£ç¨®</label>
                <select id="currencyFilter">
                    <option value="all" selected>å…¨éƒ¨</option>
                    <option value="0">é­”å¹£ ğŸ’°</option>
                    <option value="1">é­”æ™¶ ğŸ’</option>
                </select>
            </div>
            <div class="form-group">
                <label>ğŸ–¥ï¸ åˆ†æµ</label>
                <select id="serverFilter">
                    <option value="all" selected>å…¨éƒ¨</option>
                    <option value="1">S1</option>
                    <option value="2">S2</option>
                    <option value="3">S3</option>
                </select>
            </div>
            <div class="form-group">
                <label>ğŸ›¡ï¸ è€ä¹…</label>
                <select id="durabilityFilter">
                    <option value="full" selected>è€ä¹…æ»¿</option>
                    <option value="all">å…¨éƒ¨</option>
                </select>
            </div>
            <div class="form-group" style="justify-content: flex-end;">
                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                    <input type="checkbox" id="petOnlyFilter" style="width: 18px; height: 18px; cursor: pointer;">
                    ğŸ¾ åªæœå°‹å¯µç‰©
                </label>
            </div>
            <div class="form-group exchange-rate-group">
                <label>ğŸ’± åŒ¯ç‡ (é­”å¹£:é­”æ™¶)</label>
                <input type="number" id="exchangeRate" value="260" min="1">
            </div>
            <div class="form-group">
                <button id="searchBtn">ğŸ” æœå°‹å¸‚å ´</button>
            </div>
            <div class="form-group">
                <button id="historyBtn" class="secondary">ğŸ“ˆ 72Hæ­·å²æˆäº¤</button>
            </div>
        </div>

        <!-- Quick Tags -->
        <div class="quick-tags" id="quickTags"></div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid" id="statsGrid" style="display: none;">
        <div class="stat-card">
            <div class="label">ğŸ“¦ åœ¨å”®æ•¸é‡</div>
            <div class="value blue" id="statCount">0</div>
        </div>
        <div class="stat-card">
            <div class="label">ğŸ’° æœ€ä½åƒ¹</div>
            <div class="value green" id="statMinPrice">-</div>
        </div>
        <div class="stat-card">
            <div class="label">ğŸ“Š ä¸­ä½åƒ¹</div>
            <div class="value gold" id="statAvgPrice">-</div>
        </div>
        <div class="stat-card">
            <div class="label">ğŸ“ˆ æœ€é«˜åƒ¹</div>
            <div class="value red" id="statMaxPrice">-</div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs" id="tabsContainer" style="display: none;">
        <div class="tab active" data-tab="market">ğŸª å¸‚å ´æ”¤ä½</div>
        <div class="tab" data-tab="history">ğŸ“œ æ­·å²æˆäº¤</div>
    </div>

    <!-- Loading -->
    <div class="loading" id="loading" style="display: none;">
        <div class="spinner"></div>
        <div>æ­£åœ¨è¼‰å…¥è³‡æ–™...</div>
    </div>

    <!-- Market Table -->
    <div class="table-container" id="marketSection" style="display: none;">
        <div class="table-scroll">
            <table id="marketTable">
                <thead>
                    <tr>
                        <th data-sort="item">ç‰©å“åç¨±</th>
                        <th data-sort="price">åƒ¹æ ¼ <span class="sort-icon active">â–²</span></th>
                        <th>åˆ†æµ/åœ°é»</th>
                        <th>æ”¤ä½åç¨±</th>
                        <th data-sort="durability">è€ä¹…</th>
                        <th data-sort="attack">æ”»æ“Š</th>
                        <th data-sort="defence">é˜²ç¦¦</th>
                        <th data-sort="agility">æ•æ·</th>
                        <th>æ•¸é‡</th>
                    </tr>
                </thead>
                <tbody id="marketBody"></tbody>
            </table>
        </div>
    </div>

    <!-- History Section -->
    <div id="historySection" style="display: none;">
        <div class="history-summary" id="historySummary"></div>
        
        <div class="table-container">
            <div class="table-scroll">
                <table id="historyTable">
                    <thead>
                        <tr>
                            <th>ç‰©å“åç¨±</th>
                            <th>ğŸ’° æœ€ä½</th>
                            <th>ğŸ’° ä¸­ä½</th>
                            <th>ğŸ’° æœ€é«˜</th>
                            <th>ğŸ’ æœ€ä½</th>
                            <th>ğŸ’ ä¸­ä½</th>
                            <th>ğŸ’ æœ€é«˜</th>
                            <th>æˆäº¤æ•¸</th>
                            <th>èµ°å‹¢</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody"></tbody>
                </table>
            </div>
        </div>

        </div>

    <!-- Empty State -->
    <div class="empty-state" id="emptyState">
        <div class="icon">ğŸ”</div>
        <div>è¼¸å…¥ç‰©å“åç¨±é–‹å§‹æœå°‹</div>
        <div style="margin-top: 8px; font-size: 0.85rem;">æ”¯æ´æ¨¡ç³Šæœå°‹ï¼Œä¾‹å¦‚ï¼šé¢åŒ…ã€å£½å–œã€è½‰è›‹</div>
    </div>
</div>

<script>
/* ========================================
   å…¨åŸŸè®Šæ•¸
======================================== */
// CORS ä»£ç†ï¼ˆå¤šå€‹å‚™æ´ï¼‰
const CORS_PROXIES = [
    { prefix: 'https://api.codetabs.com/v1/proxy?quest=', encode: true },
    { prefix: 'https://api.allorigins.win/raw?url=', encode: true },
    { prefix: 'https://corsproxy.org/?', encode: true }
];
let currentProxyIndex = 0;

const API_MARKET_BASE = 'https://member.starcg.net/market.php';
const API_HISTORY_BASE = 'https://member.starcg.net/marketrecord.php';
const MAX_PAGES = 20;

// å˜—è©¦ fetchï¼Œå¤±æ•—å‰‡æ›ä¸‹ä¸€å€‹ proxy
async function fetchWithProxy(targetUrl) {
    let lastError;
    // åŠ ä¸Šæ™‚é–“æˆ³ç¹éå¿«å–
    const cacheBuster = `_t=${Date.now()}`;
    const urlWithCache = targetUrl + (targetUrl.includes('?') ? '&' : '?') + cacheBuster;
    
    for (let i = 0; i < CORS_PROXIES.length; i++) {
        const proxyIndex = (currentProxyIndex + i) % CORS_PROXIES.length;
        const proxy = CORS_PROXIES[proxyIndex];
        const url = proxy.prefix + (proxy.encode ? encodeURIComponent(urlWithCache) : urlWithCache);
        
        try {
            const resp = await fetch(url, { cache: 'no-store' });
            const text = await resp.text();
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºéŒ¯èª¤å›æ‡‰
            if (!resp.ok || text.startsWith('<!') || text.startsWith('<html') || text.includes('error code:')) {
                throw new Error(`Proxy ${proxyIndex} failed: ${resp.status}`);
            }
            
            // æˆåŠŸï¼Œè¨˜ä½é€™å€‹ proxy
            currentProxyIndex = proxyIndex;
            return text;
        } catch (err) {
            console.warn(`Proxy ${proxyIndex} failed:`, err.message);
            lastError = err;
        }
    }
    throw new Error('æ‰€æœ‰ä»£ç†ä¼ºæœå™¨éƒ½ç„¡æ³•é€£ç·šï¼Œè«‹ç¨å¾Œå†è©¦');
}

let allMarketItems = [];
let allHistoryLogs = [];
let quickTags = JSON.parse(localStorage.getItem('starcg_quickTags')) || ['ä¸€ç®±é¢åŒ…', 'ä¸€ç®±æ³•åœ‹é¢åŒ…', 'ä¸€ç®±å£½å–œé‹'];
let currentSort = { field: 'price', order: 'asc' };
let currentTab = 'market';
const chartInstances = {};

/* ========================================
   åˆå§‹åŒ–
======================================== */
document.addEventListener('DOMContentLoaded', () => {
    renderQuickTags();
    initEventListeners();
});

function initEventListeners() {
    // æœå°‹æŒ‰éˆ•
    document.getElementById('searchBtn').addEventListener('click', searchMarket);
    document.getElementById('historyBtn').addEventListener('click', searchHistory);
    
    // Enter éµæœå°‹
    document.getElementById('searchInput').addEventListener('keypress', e => {
        if (e.key === 'Enter') searchMarket();
    });
    
    // ç¯©é¸å™¨è®Šæ›´
    ['currencyFilter', 'serverFilter', 'durabilityFilter'].forEach(id => {
        document.getElementById(id).addEventListener('change', applyFilters);
    });
    
    // åªæœå°‹å¯µç‰© checkbox
    document.getElementById('petOnlyFilter').addEventListener('change', applyFilters);
    
    // åŒ¯ç‡è®Šæ›´æ™‚é‡æ–°æ¸²æŸ“
    document.getElementById('exchangeRate').addEventListener('input', applyFilters);
    
    // Tab åˆ‡æ›
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => switchTab(tab.dataset.tab));
    });
    
    // è¡¨é ­æ’åº
    document.querySelectorAll('#marketTable th[data-sort]').forEach(th => {
        th.addEventListener('click', () => sortTable(th.dataset.sort));
    });
}

/* ========================================
   å¿«é€Ÿæ¨™ç±¤
======================================== */
function renderQuickTags() {
    const container = document.getElementById('quickTags');
    container.innerHTML = quickTags.map((tag, i) => `
        <div class="quick-tag" onclick="quickSearch('${tag}')">
            ${tag}
            <span class="remove" onclick="event.stopPropagation(); removeTag(${i})">âœ•</span>
        </div>
    `).join('');
}

function quickSearch(tag) {
    document.getElementById('searchInput').value = tag;
    searchMarket();
}

function removeTag(index) {
    quickTags.splice(index, 1);
    localStorage.setItem('starcg_quickTags', JSON.stringify(quickTags));
    renderQuickTags();
}

function addTag(tag) {
    if (tag && !quickTags.includes(tag)) {
        quickTags.push(tag);
        localStorage.setItem('starcg_quickTags', JSON.stringify(quickTags));
        renderQuickTags();
    }
}

/* ========================================
   å¸‚å ´æœå°‹
======================================== */
async function searchMarket() {
    const keyword = document.getElementById('searchInput').value.trim();
    if (!keyword) return alert('è«‹è¼¸å…¥æœå°‹é—œéµå­—');
    
    showLoading(true);
    hideAll();
    
    // æ¸…ç©ºèˆŠçš„æ­·å²è³‡æ–™å’Œåœ–è¡¨ï¼Œè®“åˆ‡æ› tab æ™‚é‡æ–°æœå°‹
    allHistoryLogs = [];
    // éŠ·æ¯€æ‰€æœ‰åœ–è¡¨å¯¦ä¾‹
    Object.values(chartInstances).forEach(chart => chart.destroy());
    Object.keys(chartInstances).forEach(key => delete chartInstances[key]);
    
    try {
        allMarketItems = await fetchMarketData(keyword);
        
        if (allMarketItems.length > 0) {
            addTag(keyword);
            document.getElementById('tabsContainer').style.display = 'flex';
            switchTab('market');
            applyFilters();
        } else {
            showEmpty('æ‰¾ä¸åˆ°ç¬¦åˆçš„ç‰©å“');
        }
    } catch (err) {
        console.error(err);
        alert('æœå°‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–æª¢æŸ¥ç¶²è·¯é€£ç·š');
        showEmpty('æœå°‹å¤±æ•—');
    } finally {
        showLoading(false);
    }
}

// æ¨™æº–åŒ–å­—ä¸²ï¼šå…¨å½¢æ‹¬è™Ÿè½‰åŠå½¢ã€çµ±ä¸€ç©ºæ ¼ç­‰
function normalizeStr(str) {
    return str
        .replace(/ï¼ˆ/g, '(')
        .replace(/ï¼‰/g, ')')
        .replace(/ã€/g, '[')
        .replace(/ã€‘/g, ']')
        .replace(/ã€€/g, ' ');
}

async function fetchMarketData(keyword) {
    const items = [];
    let page = 1;
    let hasMore = true;
    const normalizedKeyword = normalizeStr(keyword);
    
    while (hasMore && page <= MAX_PAGES) {
        const targetUrl = `${API_MARKET_BASE}?ajax=1&type=all&server=all&exact=0&page=${page}&search=${encodeURIComponent(keyword)}`;
        const text = await fetchWithProxy(targetUrl);
        const data = JSON.parse(text);
        
        if (data.totalFiltered === 0) break;
        if (data.totalFiltered > 300) {
            alert('çµæœå¤ªå¤šï¼Œè«‹è¼¸å…¥æ›´ç²¾ç¢ºçš„é—œéµå­—');
            return [];
        }
        
        // è™•ç†æ”¤ä½è³‡æ–™
        const itemsMap = data.itemsByCd || {};
        const petsMap = data.petsByCd || {};
        
        (data.stalls || []).forEach(stall => {
            const cdkey = stall.cdkey;
            
            // é“å…·
            (itemsMap[cdkey] || []).forEach(item => {
                const normalizedItemName = normalizeStr(item.ITEM_TRUENAME);
                if (normalizedItemName.includes(normalizedKeyword)) {
                    // è™•ç†æ”¹é€ åœ–ç­‰ç´šå€åˆ†ï¼ˆå˜—è©¦å¤šç¨®å¯èƒ½çš„æ¬„ä½åï¼‰
                    let displayName = item.ITEM_TRUENAME;
                    let gradeTag = '';
                    let seedTag = '';
                    const itemLevel = item.ITEM_LEVEL || item.level || item.Level || item.ITEM_LV || item.lv || 0;
                    if (item.ITEM_TRUENAME.includes('æ”¹é€ åœ–') && itemLevel > 0) {
                        if (itemLevel === 5) gradeTag = '<span class="grade-normal">æ™®é€š</span>';
                        else if (itemLevel === 6) gradeTag = '<span class="grade-silver">éŠ€</span>';
                        else if (itemLevel === 7) gradeTag = '<span class="grade-gold">é‡‘</span>';
                        else gradeTag = `<span class="grade-normal">Lv${itemLevel}</span>`;
                    }
                    
                    // è™•ç†é‡ä¾†çš„ç¨®å­ BP é…é»é¡¯ç¤º
                    if (item.ITEM_TRUENAME.includes('é‡ä¾†çš„ç¨®å­') && item.ITEM_ARGUMENT) {
                        const bpNames = ['é«”', 'æ”»', 'é˜²', 'æ•', 'é­”'];
                        const bpValues = item.ITEM_ARGUMENT.split('|').map(Number);
                        let plusParts = [];
                        let minusParts = [];
                        bpValues.forEach((val, idx) => {
                            if (val > 0) plusParts.push(`<span class="bp-plus">+${val}${bpNames[idx]}</span>`);
                            else if (val < 0) minusParts.push(`<span class="bp-minus">${val}${bpNames[idx]}</span>`);
                        });
                        // å›ºå®šé †åºï¼š+1åœ¨å‰ï¼Œ-1åœ¨å¾Œ
                        const allParts = [...plusParts, ...minusParts];
                        if (allParts.length > 0) seedTag = allParts.join(' ');
                    }
                    
                    items.push({
                        item: displayName,
                        gradeTag: gradeTag,
                        seedTag: seedTag,
                        itemLevel: itemLevel,
                        price: item.price,
                        pricetype: item.pricetype,
                        durability: `${item.ITEM_DURABILITY}/${item.ITEM_MAXDURABILITY}`,
                        durCurrent: item.ITEM_DURABILITY,
                        durMax: item.ITEM_MAXDURABILITY,
                        attack: Math.max(item.ITEM_ADM || 0, item.ITEM_MODIFYATTACK || 0),
                        defence: item.ITEM_MODIFYDEFENCE || 0,
                        agility: item.ITEM_MODIFYAGILITY || 0,
                        location: stall.coords,
                        server: stall.server,
                        shopName: stall.name,
                        count: item.ITEM_REMAIN,
                        isPet: false
                    });
                }
            });
            
            // å¯µç‰©
            (petsMap[cdkey] || []).forEach(pet => {
                const normalizedPetName = normalizeStr(pet.Name);
                if (normalizedPetName.includes(normalizedKeyword)) {
                    // å¯µç‰©æ¨™ç±¤ï¼šç­‰ç´šã€æ”¹é€ ã€æŠ€èƒ½æ¬„æ•¸
                    const petLv = pet.Lv || 1;
                    const trans = pet.Trans || 0;
                    const slot = pet.Slot || 6;
                    
                    let petTags = `<span class="pet-lv">Lv${petLv}</span>`;
                    petTags += `<span class="pet-trans">${trans}æ”¹</span>`;
                    petTags += `<span class="pet-slot">${slot}æŠ€</span>`;
                    
                    items.push({
                        item: pet.Name,
                        transTag: petTags,
                        gradeTag: '',
                        price: pet.price,
                        pricetype: pet.pricetype,
                        durability: '-',
                        durCurrent: 0,
                        durMax: 0,
                        attack: '-',
                        defence: '-',
                        agility: '-',
                        location: stall.coords,
                        server: stall.server,
                        shopName: stall.name,
                        count: 1,
                        isPet: true
                    });
                }
            });
        });
        
        if (page * (data.perPage || 20) >= data.totalFiltered) hasMore = false;
        page++;
    }
    
    return items;
}

/* ========================================
   æ­·å²æˆäº¤æœå°‹
======================================== */
async function searchHistory() {
    const keyword = document.getElementById('searchInput').value.trim();
    if (!keyword) return alert('è«‹è¼¸å…¥æœå°‹é—œéµå­—');
    
    showLoading(true);
    hideAll();
    
    try {
        allHistoryLogs = await fetchHistoryData(keyword);
        
        if (allHistoryLogs.length > 0) {
            addTag(keyword);
            document.getElementById('tabsContainer').style.display = 'flex';
            switchTab('history');
            renderHistoryData();
        } else {
            showEmpty('æ‰¾ä¸åˆ°æ­·å²æˆäº¤è¨˜éŒ„');
        }
    } catch (err) {
        console.error(err);
        alert('æœå°‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–æª¢æŸ¥ç¶²è·¯é€£ç·š');
        showEmpty('æœå°‹å¤±æ•—');
    } finally {
        showLoading(false);
    }
}

async function fetchHistoryData(keyword) {
    const logs = [];
    const TIME_RANGE = 72 * 60 * 60 * 1000; // 72å°æ™‚
    const now = Date.now();
    let page = 1;
    let keepFetching = true;
    
    while (keepFetching && page <= 100) {
        const targetUrl = `${API_HISTORY_BASE}?ajax=1&type=all&page=${page}&search=${encodeURIComponent(keyword)}`;
        const text = await fetchWithProxy(targetUrl);
        const data = JSON.parse(text);
        
        if (!data.logs || data.logs.length === 0) break;
        
        for (const log of data.logs) {
            const logTime = new Date(log.time_text).getTime();
            if (now - logTime > TIME_RANGE) {
                keepFetching = false;
                break;
            }
            
            // è§£æç‰©å“åç¨±å’Œæ•¸é‡ï¼ˆæ ¼å¼ï¼šã€Œè³¼è²·Xå€‹ï¼šç‰©å“åç¨±ã€æˆ–ã€Œè³¼è²·Xå€‹:ç‰©å“åç¨±ã€ï¼‰
            const qtyMatch = log.buff.match(/è³¼è²·(\d+)å€‹[ï¼š:]/);
            const quantity = qtyMatch ? parseInt(qtyMatch[1]) : 1;
            const parts = log.buff.split(/[ï¼š:]/);
            const itemName = parts.length > 1 ? parts[1] : parts[0];
            
            // é‚„åŸå”®åƒ¹ï¼ˆæ‰£é™¤æ‰‹çºŒè²»ï¼‰ä¸¦è¨ˆç®—å–®åƒ¹
            const originalTotalPrice = Math.ceil(log.price / (log.pricetype === 1 ? 0.94 : 0.9));
            const unitPrice = Math.ceil(originalTotalPrice / quantity);
            
            logs.push({
                item: itemName,
                price: unitPrice,
                pricetype: log.pricetype,
                time: log.time_text,
                quantity: quantity
            });
        }
        
        page++;
    }
    
    return logs;
}

/* ========================================
   ç¯©é¸èˆ‡æ’åº
======================================== */
function applyFilters() {
    const currency = document.getElementById('currencyFilter').value;
    const server = document.getElementById('serverFilter').value;
    const durability = document.getElementById('durabilityFilter').value;
    const petOnly = document.getElementById('petOnlyFilter').checked;
    
    let filtered = [...allMarketItems];
    
    // åªæœå°‹å¯µç‰©
    if (petOnly) {
        filtered = filtered.filter(i => i.isPet === true);
    }
    
    // å¹£ç¨®ç¯©é¸
    if (currency !== 'all') {
        filtered = filtered.filter(i => i.pricetype.toString() === currency);
    }
    
    // åˆ†æµç¯©é¸
    if (server !== 'all') {
        filtered = filtered.filter(i => i.server.toString() === server);
    }
    
    // è€ä¹…ç¯©é¸
    if (durability === 'full') {
        filtered = filtered.filter(i => i.isPet || i.durCurrent === i.durMax);
    }
    
    // æ’åº
    filtered = sortItems(filtered);
    
    // æ›´æ–°çµ±è¨ˆ
    updateStats(filtered);
    
    // æ¸²æŸ“è¡¨æ ¼
    renderMarketTable(filtered);
}

function sortItems(items) {
    const { field, order } = currentSort;
    
    return [...items].sort((a, b) => {
        let valA = a[field];
        let valB = b[field];
        
        // è€ä¹…ç‰¹æ®Šè™•ç†
        if (field === 'durability') {
            valA = a.durCurrent;
            valB = b.durCurrent;
        }
        
        if (typeof valA === 'string') {
            return order === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
        }
        return order === 'asc' ? valA - valB : valB - valA;
    });
}

function sortTable(field) {
    if (currentSort.field === field) {
        currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort = { field, order: 'asc' };
    }
    
    // æ›´æ–°æ’åºåœ–ç¤º
    document.querySelectorAll('#marketTable th .sort-icon').forEach(icon => {
        icon.classList.remove('active');
        icon.textContent = 'â–²';
    });
    
    const th = document.querySelector(`#marketTable th[data-sort="${field}"]`);
    if (th) {
        const icon = th.querySelector('.sort-icon') || document.createElement('span');
        icon.className = 'sort-icon active';
        icon.textContent = currentSort.order === 'asc' ? 'â–²' : 'â–¼';
        if (!th.querySelector('.sort-icon')) th.appendChild(icon);
    }
    
    applyFilters();
}

/* ========================================
   æ¸²æŸ“
======================================== */
function renderMarketTable(items) {
    const tbody = document.getElementById('marketBody');
    
    if (items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;color:var(--text-secondary);">ç„¡ç¬¦åˆæ¢ä»¶çš„ç‰©å“</td></tr>';
        document.getElementById('marketSection').style.display = 'block';
        return;
    }
    
    // åˆä½µç›¸åŒç‰©å“ï¼ˆåŒæ”¤ä½ã€åŒç‰©å“ã€åŒåƒ¹æ ¼ã€åŒæ•¸å€¼æ‰åˆä½µï¼‰
    const merged = {};
    items.forEach(item => {
        // å¯µç‰©ä¸åˆä½µï¼ˆæ¯éš»éƒ½æ˜¯ç¨ç«‹å€‹é«”ï¼‰
        if (item.isPet) {
            const uniqueKey = `pet-${Date.now()}-${Math.random()}`;
            merged[uniqueKey] = { ...item };
        } else {
            // ä¸€èˆ¬ç‰©å“ï¼šåŒæ”¤ä½+åŒç‰©å“+åŒåƒ¹æ ¼+åŒæ•¸å€¼+åŒBPé…é»æ‰åˆä½µ
            const key = `${item.location}-${item.item}-${item.price}-${item.server}-${item.durability}-${item.attack}-${item.defence}-${item.agility}-${item.seedTag || ''}`;
            if (!merged[key]) {
                merged[key] = { ...item };
            } else {
                merged[key].count += item.count;
            }
        }
    });
    
    const rate = parseInt(document.getElementById('exchangeRate').value) || 300;
    
    tbody.innerHTML = Object.values(merged).map(item => {
        // è¨ˆç®—æ›ç®—åƒ¹æ ¼
        let converted = '';
        if (item.pricetype === 0) {
            // é­”å¹£æ›ç®—æˆé­”æ™¶
            const crystalVal = Math.round(item.price / rate);
            converted = `<span class="converted">(~${crystalVal.toLocaleString()}ğŸ’)</span>`;
        } else {
            // é­”æ™¶æ›ç®—æˆé­”å¹£
            const coinVal = Math.round(item.price * rate);
            converted = `<span class="converted">(~${coinVal.toLocaleString()}ğŸ’°)</span>`;
        }
        
        return `
        <tr>
            <td><strong>${escapeHtml(item.item)}</strong> ${item.gradeTag || ''}${item.seedTag || ''}${item.transTag || ''}</td>
            <td>
                <span class="price ${item.pricetype === 0 ? 'coin' : 'crystal'}">
                    ${item.pricetype === 0 ? 'ğŸ’°' : 'ğŸ’'} ${item.price.toLocaleString()}
                </span>
                ${converted}
            </td>
            <td>
                <span class="server-badge s${item.server}">S${item.server}</span>
                ${escapeHtml(item.location)}
            </td>
            <td>${escapeHtml(item.shopName)}</td>
            <td>${item.durability}</td>
            <td>${item.attack || '-'}</td>
            <td>${item.defence || '-'}</td>
            <td>${item.agility || '-'}</td>
            <td>${item.count}</td>
        </tr>`;
    }).join('');
    
    document.getElementById('marketSection').style.display = 'block';
}

function renderHistoryData() {
    // æŒ‰ç‰©å“åˆ†çµ„çµ±è¨ˆ
    const grouped = {};
    
    allHistoryLogs.forEach(log => {
        if (!grouped[log.item]) {
            grouped[log.item] = { coins: [], crystals: [], total: 0 };
        }
        if (log.pricetype === 0) {
            grouped[log.item].coins.push(log.price);
        } else {
            grouped[log.item].crystals.push(log.price);
        }
        grouped[log.item].total++;
    });
    
    // è¨ˆç®—çµ±è¨ˆ
    const stats = Object.entries(grouped).map(([item, data]) => ({
        item,
        minCoin: data.coins.length ? Math.min(...data.coins) : 0,
        maxCoin: data.coins.length ? Math.max(...data.coins) : 0,
        avgCoin: data.coins.length ? calcTrimmedAvg(data.coins) : 0,
        minCrystal: data.crystals.length ? Math.min(...data.crystals) : 0,
        maxCrystal: data.crystals.length ? Math.max(...data.crystals) : 0,
        avgCrystal: data.crystals.length ? calcTrimmedAvg(data.crystals) : 0,
        total: data.total
    }));
    
    // æ¸²æŸ“è¡¨æ ¼ï¼ˆæ¯å€‹ç‰©ä»¶å¾Œé¢åŠ ä¸Šåœ–è¡¨è¡Œï¼‰
    const tbody = document.getElementById('historyBody');
    tbody.innerHTML = stats.map((row, index) => `
        <tr>
            <td><strong>${escapeHtml(row.item)}</strong></td>
            <td style="color:var(--accent-green)">${row.minCoin ? row.minCoin.toLocaleString() : '-'}</td>
            <td style="color:var(--accent-gold)">${row.avgCoin ? row.avgCoin.toLocaleString() : '-'}</td>
            <td style="color:var(--accent-red)">${row.maxCoin ? row.maxCoin.toLocaleString() : '-'}</td>
            <td style="color:var(--accent-green)">${row.minCrystal ? row.minCrystal.toLocaleString() : '-'}</td>
            <td style="color:var(--accent-gold)">${row.avgCrystal ? row.avgCrystal.toLocaleString() : '-'}</td>
            <td style="color:var(--accent-red)">${row.maxCrystal ? row.maxCrystal.toLocaleString() : '-'}</td>
            <td>${row.total}</td>
            <td><button class="secondary" style="padding:6px 12px;font-size:0.8rem;" onclick="toggleChart(${index}, '${escapeHtml(row.item)}')">ğŸ“ˆ</button></td>
        </tr>
        <tr id="chartRow${index}" class="chart-row" style="display:none;">
            <td colspan="9" style="padding:0; background:var(--bg-dark);">
                <div class="inline-chart-container">
                    <div class="chart-title">ğŸ“ˆ ${escapeHtml(row.item)} åƒ¹æ ¼èµ°å‹¢</div>
                    <div class="inline-chart-wrapper">
                        <canvas id="chart${index}"></canvas>
                    </div>
                </div>
            </td>
        </tr>
    `).join('');
    
    document.getElementById('historySection').style.display = 'block';
}

function toggleChart(index, itemName) {
    const chartRow = document.getElementById(`chartRow${index}`);
    const isVisible = chartRow.style.display !== 'none';
    
    if (isVisible) {
        chartRow.style.display = 'none';
        return;
    }
    
    chartRow.style.display = '';
    
    // å¦‚æœå·²ç¶“ç•«éå°±ä¸é‡ç•«
    if (chartInstances[index]) return;
    
    // ç¯©é¸è©²ç‰©å“çš„è³‡æ–™ä¸¦ç°¡åŒ–
    const itemLogs = allHistoryLogs.filter(l => l.item === itemName);
    const coinData = simplifyData(itemLogs.filter(l => l.pricetype === 0).sort((a, b) => new Date(a.time) - new Date(b.time)));
    const crystalData = simplifyData(itemLogs.filter(l => l.pricetype === 1).sort((a, b) => new Date(a.time) - new Date(b.time)));
    
    const ctx = document.getElementById(`chart${index}`).getContext('2d');
    
    const datasets = [];
    if (coinData.length > 0) {
        datasets.push({
            label: 'é­”å¹£ ğŸ’°',
            data: coinData.map(d => ({ x: d.time, y: d.price })),
            borderColor: '#d4a024',
            backgroundColor: 'rgba(212, 160, 36, 0.15)',
            tension: 0.4,
            pointRadius: 3,
            borderWidth: 2,
            fill: true
        });
    }
    if (crystalData.length > 0) {
        datasets.push({
            label: 'é­”æ™¶ ğŸ’',
            data: crystalData.map(d => ({ x: d.time, y: d.price })),
            borderColor: '#9068b0',
            backgroundColor: 'rgba(144, 104, 176, 0.15)',
            tension: 0.4,
            pointRadius: 3,
            borderWidth: 2,
            fill: true
        });
    }
    
    chartInstances[index] = new Chart(ctx, {
        type: 'line',
        data: { datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { intersect: false, mode: 'index' },
            plugins: {
                legend: { display: true, labels: { color: '#4a3f35' } },
                tooltip: {
                    backgroundColor: '#fffbf5',
                    borderColor: '#e0d5c5',
                    borderWidth: 1,
                    titleColor: '#4a3f35',
                    bodyColor: '#8b7355'
                }
            },
            scales: {
                x: {
                    type: 'category',
                    ticks: { 
                        color: '#8b7355',
                        maxTicksLimit: 8,
                        maxRotation: 45,
                        minRotation: 0
                    },
                    grid: { color: '#e0d5c5' }
                },
                y: {
                    ticks: { color: '#8b7355' },
                    grid: { color: '#e0d5c5' }
                }
            }
        }
    });
}

// ç°¡åŒ–æ•¸æ“šï¼šåˆä½µç›¸åŒåƒ¹æ ¼çš„é€£çºŒæ•¸æ“šé»
function simplifyData(data) {
    if (data.length <= 20) return data;
    
    const simplified = [];
    let lastPrice = null;
    let lastTime = null;
    
    data.forEach((d, i) => {
        // ä¿ç•™ç¬¬ä¸€ç­†ã€æœ€å¾Œä¸€ç­†ã€åƒ¹æ ¼è®ŠåŒ–çš„é»
        if (i === 0 || i === data.length - 1 || d.price !== lastPrice) {
            // å¦‚æœè·³éäº†å¾ˆå¤šç›¸åŒåƒ¹æ ¼çš„é»ï¼ŒåŠ ä¸€å€‹ä¸­é–“é»æ¨™è¨˜
            if (lastPrice !== null && d.price === lastPrice && simplified.length > 0) {
                // å·²ç¶“æœ‰ç›¸åŒåƒ¹æ ¼çš„èµ·é»äº†ï¼Œè·³é
            } else {
                simplified.push(d);
            }
            lastPrice = d.price;
            lastTime = d.time;
        }
    });
    
    return simplified;
}


function updateStats(items) {
    const currency = document.getElementById('currencyFilter').value;
    const rate = parseInt(document.getElementById('exchangeRate').value) || 260;
    
    if (currency === 'all') {
        // åˆ†åˆ¥è¨ˆç®—å…©ç¨®å¹£ç¨®çš„æ•¸é‡
        const coinCount = items.filter(i => i.pricetype === 0).reduce((sum, i) => sum + i.count, 0);
        const crystalCount = items.filter(i => i.pricetype === 1).reduce((sum, i) => sum + i.count, 0);
        
        // åœ¨å”®æ•¸é‡ï¼šä¸€è¡Œé­”å¹£ã€ä¸€è¡Œé­”æ™¶
        const countLines = [];
        if (coinCount > 0) countLines.push(`ğŸ’° ${coinCount.toLocaleString()}`);
        if (crystalCount > 0) countLines.push(`ğŸ’ ${crystalCount.toLocaleString()}`);
        document.getElementById('statCount').innerHTML = countLines.length > 0 ? countLines.join('<br>') : '-';
    } else {
        // å–®ä¸€å¹£ç¨®æ¨¡å¼
        const totalCount = items.reduce((sum, i) => sum + i.count, 0);
        document.getElementById('statCount').textContent = totalCount.toLocaleString();
    }
    
    if (currency === 'all') {
        // åˆ†åˆ¥è¨ˆç®—å…©ç¨®å¹£ç¨®çš„åƒ¹æ ¼
        const coinPrices = items.filter(i => i.pricetype === 0).map(i => i.price);
        const crystalPrices = items.filter(i => i.pricetype === 1).map(i => i.price);
        
        // è¨ˆç®—æ˜Ÿå¹£çµ±è¨ˆ
        const coinMin = coinPrices.length ? Math.min(...coinPrices) : 0;
        const coinMax = coinPrices.length ? Math.max(...coinPrices) : 0;
        const coinAvg = coinPrices.length ? calcTrimmedAvg(coinPrices) : 0;
        
        // è¨ˆç®—é­”æ™¶çµ±è¨ˆ
        const crystalMin = crystalPrices.length ? Math.min(...crystalPrices) : 0;
        const crystalMax = crystalPrices.length ? Math.max(...crystalPrices) : 0;
        const crystalAvg = crystalPrices.length ? calcTrimmedAvg(crystalPrices) : 0;
        
        // æ ¼å¼åŒ–é¡¯ç¤ºï¼šä¸»è¦åƒ¹æ ¼ (~æ›ç®—åƒ¹æ ¼)
        const formatPrice = (mainPrice, convertedPrice, convertedIcon) => {
            if (mainPrice === 0) return '-';
            const converted = convertedPrice > 0 ? ` (~${convertedPrice.toLocaleString()}${convertedIcon})` : '';
            return `${mainPrice.toLocaleString()}${converted}`;
        };
        
        // æœ€ä½åƒ¹ï¼šæ˜Ÿå¹£æœ€ä½ (~é­”æ™¶æ›ç®—) / é­”æ™¶æœ€ä½ (~æ˜Ÿå¹£æ›ç®—)
        const minCoinText = coinMin > 0 ? `ğŸ’° ${formatPrice(coinMin, Math.round(coinMin / rate), 'ğŸ’')}` : '';
        const minCrystalText = crystalMin > 0 ? `ğŸ’ ${formatPrice(crystalMin, Math.round(crystalMin * rate), 'ğŸ’°')}` : '';
        document.getElementById('statMinPrice').innerHTML = [minCoinText, minCrystalText].filter(Boolean).join('<br>') || '-';
        
        // ä¸­ä½åƒ¹ï¼šæ˜Ÿå¹£ä¸­ä½ (~é­”æ™¶æ›ç®—) / é­”æ™¶ä¸­ä½ (~æ˜Ÿå¹£æ›ç®—)
        const avgCoinText = coinAvg > 0 ? `ğŸ’° ${formatPrice(coinAvg, Math.round(coinAvg / rate), 'ğŸ’')}` : '';
        const avgCrystalText = crystalAvg > 0 ? `ğŸ’ ${formatPrice(crystalAvg, Math.round(crystalAvg * rate), 'ğŸ’°')}` : '';
        document.getElementById('statAvgPrice').innerHTML = [avgCoinText, avgCrystalText].filter(Boolean).join('<br>') || '-';
        
        // æœ€é«˜åƒ¹ï¼šæ˜Ÿå¹£æœ€é«˜ (~é­”æ™¶æ›ç®—) / é­”æ™¶æœ€é«˜ (~æ˜Ÿå¹£æ›ç®—)
        const maxCoinText = coinMax > 0 ? `ğŸ’° ${formatPrice(coinMax, Math.round(coinMax / rate), 'ğŸ’')}` : '';
        const maxCrystalText = crystalMax > 0 ? `ğŸ’ ${formatPrice(crystalMax, Math.round(crystalMax * rate), 'ğŸ’°')}` : '';
        document.getElementById('statMaxPrice').innerHTML = [maxCoinText, maxCrystalText].filter(Boolean).join('<br>') || '-';
    } else {
        // å–®ä¸€å¹£ç¨®æ¨¡å¼ï¼ˆåŸæœ‰é‚è¼¯ï¼‰
        const priceType = currency === '1' ? 1 : 0;
        const prices = items
            .filter(i => i.pricetype === priceType)
            .map(i => i.price);
        
        document.getElementById('statMinPrice').textContent = prices.length ? Math.min(...prices).toLocaleString() : '-';
        document.getElementById('statMaxPrice').textContent = prices.length ? Math.max(...prices).toLocaleString() : '-';
        document.getElementById('statAvgPrice').textContent = prices.length ? calcTrimmedAvg(prices).toLocaleString() : '-';
    }
    
    document.getElementById('statsGrid').style.display = 'grid';
}

/* ========================================
   UI è¼”åŠ©
======================================== */
async function switchTab(tab) {
    currentTab = tab;
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelector(`.tab[data-tab="${tab}"]`).classList.add('active');
    
    document.getElementById('marketSection').style.display = tab === 'market' ? 'block' : 'none';
    document.getElementById('historySection').style.display = tab === 'history' ? 'block' : 'none';
    document.getElementById('statsGrid').style.display = tab === 'market' ? 'grid' : 'none';
    
    // åˆ‡æ›åˆ°æ­·å²æˆäº¤æ™‚ï¼Œå¦‚æœé‚„æ²’æœ‰è³‡æ–™å°±è‡ªå‹•æœå°‹
    if (tab === 'history' && allHistoryLogs.length === 0) {
        const keyword = document.getElementById('searchInput').value.trim();
        if (keyword) {
            showLoading(true);
            document.getElementById('historySection').style.display = 'none';
            try {
                allHistoryLogs = await fetchHistoryData(keyword);
                if (allHistoryLogs.length > 0) {
                    renderHistoryData();
                    document.getElementById('historySection').style.display = 'block';
                } else {
                    showEmpty('æ‰¾ä¸åˆ°æ­·å²æˆäº¤è¨˜éŒ„');
                }
            } catch (err) {
                console.error(err);
                showEmpty('æœå°‹æ­·å²å¤±æ•—');
            } finally {
                showLoading(false);
            }
        }
    }
}

function showLoading(show) {
    document.getElementById('loading').style.display = show ? 'block' : 'none';
}

function hideAll() {
    document.getElementById('emptyState').style.display = 'none';
    document.getElementById('marketSection').style.display = 'none';
    document.getElementById('historySection').style.display = 'none';
    document.getElementById('statsGrid').style.display = 'none';
}

function showEmpty(msg) {
    document.getElementById('emptyState').innerHTML = `
        <div class="icon">ğŸ˜¢</div>
        <div>${msg}</div>
    `;
    document.getElementById('emptyState').style.display = 'block';
}

function escapeHtml(str) {
    if (!str) return '';
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
}

function calcTrimmedAvg(arr) {
    if (!arr.length) return 0;
    if (arr.length <= 2) {
        return Math.floor(arr.reduce((a, b) => a + b, 0) / arr.length);
    }
    const sorted = [...arr].sort((a, b) => a - b);
    const start = Math.floor(sorted.length * 0.1);
    const end = Math.ceil(sorted.length * 0.9);
    const trimmed = sorted.slice(start, end);
    return Math.floor(trimmed.reduce((a, b) => a + b, 0) / trimmed.length);
}
</script>

</body>
</html>

